import{R as so,P as lo,E as co,V as ae,M as Me,T as Pe,Q as Xe,S as _e,a as ye,b as ho,i as uo,c as po,d as vo,D as fo,C as mo,A as yo,s as wo,B as xo,e as Je,f as $e,g as go}from"./game-mSYRSk27.js";const je={type:"change"},Oe={type:"start"},Ze={type:"end"},Ve=new so,Qe=new lo,bo=Math.cos(70*ho.DEG2RAD);class Eo extends co{constructor(xe,d){super(),this.object=xe,this.domElement=d,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new ae,this.cursor=new ae,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Me.ROTATE,MIDDLE:Me.DOLLY,RIGHT:Me.PAN},this.touches={ONE:Pe.ROTATE,TWO:Pe.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(E){E.addEventListener("keydown",Ft),this._domElementKeyEvents=E},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Ft),this._domElementKeyEvents=null},this.saveState=function(){v.target0.copy(v.target),v.position0.copy(v.object.position),v.zoom0=v.object.zoom},this.reset=function(){v.target.copy(v.target0),v.object.position.copy(v.position0),v.object.zoom=v.zoom0,v.object.updateProjectionMatrix(),v.dispatchEvent(je),v.update(),u=_.NONE},this.update=function(){const E=new ae,pt=new Xe().setFromUnitVectors(xe.up,new ae(0,1,0)),zt=pt.clone().invert(),Wt=new ae,Dt=new Xe,_t=new ae,Gt=2*Math.PI;return function(he=null){const $t=v.object.position;E.copy($t).sub(v.target),E.applyQuaternion(pt),r.setFromVector3(E),v.autoRotate&&u===_.NONE&&A(D(he)),v.enableDamping?(r.theta+=n.theta*v.dampingFactor,r.phi+=n.phi*v.dampingFactor):(r.theta+=n.theta,r.phi+=n.phi);let Ot=v.minAzimuthAngle,jt=v.maxAzimuthAngle;isFinite(Ot)&&isFinite(jt)&&(Ot<-Math.PI?Ot+=Gt:Ot>Math.PI&&(Ot-=Gt),jt<-Math.PI?jt+=Gt:jt>Math.PI&&(jt-=Gt),Ot<=jt?r.theta=Math.max(Ot,Math.min(jt,r.theta)):r.theta=r.theta>(Ot+jt)/2?Math.max(Ot,r.theta):Math.min(jt,r.theta)),r.phi=Math.max(v.minPolarAngle,Math.min(v.maxPolarAngle,r.phi)),r.makeSafe(),v.enableDamping===!0?v.target.addScaledVector(o,v.dampingFactor):v.target.add(o),v.target.sub(v.cursor),v.target.clampLength(v.minTargetRadius,v.maxTargetRadius),v.target.add(v.cursor),v.zoomToCursor&&U||v.object.isOrthographicCamera?r.radius=j(r.radius):r.radius=j(r.radius*l),E.setFromSpherical(r),E.applyQuaternion(zt),$t.copy(v.target).add(E),v.object.lookAt(v.target),v.enableDamping===!0?(n.theta*=1-v.dampingFactor,n.phi*=1-v.dampingFactor,o.multiplyScalar(1-v.dampingFactor)):(n.set(0,0,0),o.set(0,0,0));let fe=!1;if(v.zoomToCursor&&U){let ie=null;if(v.object.isPerspectiveCamera){const ue=E.length();ie=j(ue*l);const me=ue-ie;v.object.position.addScaledVector(m,me),v.object.updateMatrixWorld()}else if(v.object.isOrthographicCamera){const ue=new ae(B.x,B.y,0);ue.unproject(v.object),v.object.zoom=Math.max(v.minZoom,Math.min(v.maxZoom,v.object.zoom/l)),v.object.updateProjectionMatrix(),fe=!0;const me=new ae(B.x,B.y,0);me.unproject(v.object),v.object.position.sub(me).add(ue),v.object.updateMatrixWorld(),ie=E.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),v.zoomToCursor=!1;ie!==null&&(this.screenSpacePanning?v.target.set(0,0,-1).transformDirection(v.object.matrix).multiplyScalar(ie).add(v.object.position):(Ve.origin.copy(v.object.position),Ve.direction.set(0,0,-1).transformDirection(v.object.matrix),Math.abs(v.object.up.dot(Ve.direction))<bo?xe.lookAt(v.target):(Qe.setFromNormalAndCoplanarPoint(v.object.up,v.target),Ve.intersectPlane(Qe,v.target))))}else v.object.isOrthographicCamera&&(v.object.zoom=Math.max(v.minZoom,Math.min(v.maxZoom,v.object.zoom/l)),v.object.updateProjectionMatrix(),fe=!0);return l=1,U=!1,fe||Wt.distanceToSquared(v.object.position)>e||8*(1-Dt.dot(v.object.quaternion))>e||_t.distanceToSquared(v.target)>0?(v.dispatchEvent(je),Wt.copy(v.object.position),Dt.copy(v.object.quaternion),_t.copy(v.target),!0):!1}}(),this.dispose=function(){v.domElement.removeEventListener("contextmenu",St),v.domElement.removeEventListener("pointerdown",mt),v.domElement.removeEventListener("pointercancel",ht),v.domElement.removeEventListener("wheel",Pt),v.domElement.removeEventListener("pointermove",Vt),v.domElement.removeEventListener("pointerup",ht),v._domElementKeyEvents!==null&&(v._domElementKeyEvents.removeEventListener("keydown",Ft),v._domElementKeyEvents=null)};const v=this,_={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let u=_.NONE;const e=1e-6,r=new _e,n=new _e;let l=1;const o=new ae,t=new ye,i=new ye,a=new ye,s=new ye,h=new ye,c=new ye,p=new ye,f=new ye,w=new ye,m=new ae,B=new ye;let U=!1;const Y=[],V={};function D(E){return E!==null?2*Math.PI/60*v.autoRotateSpeed*E:2*Math.PI/60/60*v.autoRotateSpeed}function R(){return Math.pow(.95,v.zoomSpeed)}function A(E){n.theta-=E}function F(E){n.phi-=E}const I=function(){const E=new ae;return function(zt,Wt){E.setFromMatrixColumn(Wt,0),E.multiplyScalar(-zt),o.add(E)}}(),$=function(){const E=new ae;return function(zt,Wt){v.screenSpacePanning===!0?E.setFromMatrixColumn(Wt,1):(E.setFromMatrixColumn(Wt,0),E.crossVectors(v.object.up,E)),E.multiplyScalar(zt),o.add(E)}}(),J=function(){const E=new ae;return function(zt,Wt){const Dt=v.domElement;if(v.object.isPerspectiveCamera){const _t=v.object.position;E.copy(_t).sub(v.target);let Gt=E.length();Gt*=Math.tan(v.object.fov/2*Math.PI/180),I(2*zt*Gt/Dt.clientHeight,v.object.matrix),$(2*Wt*Gt/Dt.clientHeight,v.object.matrix)}else v.object.isOrthographicCamera?(I(zt*(v.object.right-v.object.left)/v.object.zoom/Dt.clientWidth,v.object.matrix),$(Wt*(v.object.top-v.object.bottom)/v.object.zoom/Dt.clientHeight,v.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),v.enablePan=!1)}}();function vt(E){v.object.isPerspectiveCamera||v.object.isOrthographicCamera?l/=E:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),v.enableZoom=!1)}function z(E){v.object.isPerspectiveCamera||v.object.isOrthographicCamera?l*=E:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),v.enableZoom=!1)}function C(E){if(!v.zoomToCursor)return;U=!0;const pt=v.domElement.getBoundingClientRect(),zt=E.clientX-pt.left,Wt=E.clientY-pt.top,Dt=pt.width,_t=pt.height;B.x=zt/Dt*2-1,B.y=-(Wt/_t)*2+1,m.set(B.x,B.y,1).unproject(v.object).sub(v.object.position).normalize()}function j(E){return Math.max(v.minDistance,Math.min(v.maxDistance,E))}function q(E){t.set(E.clientX,E.clientY)}function b(E){C(E),p.set(E.clientX,E.clientY)}function T(E){s.set(E.clientX,E.clientY)}function g(E){i.set(E.clientX,E.clientY),a.subVectors(i,t).multiplyScalar(v.rotateSpeed);const pt=v.domElement;A(2*Math.PI*a.x/pt.clientHeight),F(2*Math.PI*a.y/pt.clientHeight),t.copy(i),v.update()}function x(E){f.set(E.clientX,E.clientY),w.subVectors(f,p),w.y>0?vt(R()):w.y<0&&z(R()),p.copy(f),v.update()}function y(E){h.set(E.clientX,E.clientY),c.subVectors(h,s).multiplyScalar(v.panSpeed),J(c.x,c.y),s.copy(h),v.update()}function M(E){C(E),E.deltaY<0?z(R()):E.deltaY>0&&vt(R()),v.update()}function H(E){let pt=!1;switch(E.code){case v.keys.UP:E.ctrlKey||E.metaKey||E.shiftKey?F(2*Math.PI*v.rotateSpeed/v.domElement.clientHeight):J(0,v.keyPanSpeed),pt=!0;break;case v.keys.BOTTOM:E.ctrlKey||E.metaKey||E.shiftKey?F(-2*Math.PI*v.rotateSpeed/v.domElement.clientHeight):J(0,-v.keyPanSpeed),pt=!0;break;case v.keys.LEFT:E.ctrlKey||E.metaKey||E.shiftKey?A(2*Math.PI*v.rotateSpeed/v.domElement.clientHeight):J(v.keyPanSpeed,0),pt=!0;break;case v.keys.RIGHT:E.ctrlKey||E.metaKey||E.shiftKey?A(-2*Math.PI*v.rotateSpeed/v.domElement.clientHeight):J(-v.keyPanSpeed,0),pt=!0;break}pt&&(E.preventDefault(),v.update())}function W(){if(Y.length===1)t.set(Y[0].pageX,Y[0].pageY);else{const E=.5*(Y[0].pageX+Y[1].pageX),pt=.5*(Y[0].pageY+Y[1].pageY);t.set(E,pt)}}function S(){if(Y.length===1)s.set(Y[0].pageX,Y[0].pageY);else{const E=.5*(Y[0].pageX+Y[1].pageX),pt=.5*(Y[0].pageY+Y[1].pageY);s.set(E,pt)}}function L(){const E=Y[0].pageX-Y[1].pageX,pt=Y[0].pageY-Y[1].pageY,zt=Math.sqrt(E*E+pt*pt);p.set(0,zt)}function Z(){v.enableZoom&&L(),v.enablePan&&S()}function dt(){v.enableZoom&&L(),v.enableRotate&&W()}function ct(E){if(Y.length==1)i.set(E.pageX,E.pageY);else{const zt=ce(E),Wt=.5*(E.pageX+zt.x),Dt=.5*(E.pageY+zt.y);i.set(Wt,Dt)}a.subVectors(i,t).multiplyScalar(v.rotateSpeed);const pt=v.domElement;A(2*Math.PI*a.x/pt.clientHeight),F(2*Math.PI*a.y/pt.clientHeight),t.copy(i)}function at(E){if(Y.length===1)h.set(E.pageX,E.pageY);else{const pt=ce(E),zt=.5*(E.pageX+pt.x),Wt=.5*(E.pageY+pt.y);h.set(zt,Wt)}c.subVectors(h,s).multiplyScalar(v.panSpeed),J(c.x,c.y),s.copy(h)}function k(E){const pt=ce(E),zt=E.pageX-pt.x,Wt=E.pageY-pt.y,Dt=Math.sqrt(zt*zt+Wt*Wt);f.set(0,Dt),w.set(0,Math.pow(f.y/p.y,v.zoomSpeed)),vt(w.y),p.copy(f)}function Q(E){v.enableZoom&&k(E),v.enablePan&&at(E)}function Ct(E){v.enableZoom&&k(E),v.enableRotate&&ct(E)}function mt(E){v.enabled!==!1&&(Y.length===0&&(v.domElement.setPointerCapture(E.pointerId),v.domElement.addEventListener("pointermove",Vt),v.domElement.addEventListener("pointerup",ht)),Ut(E),E.pointerType==="touch"?Mt(E):Rt(E))}function Vt(E){v.enabled!==!1&&(E.pointerType==="touch"?It(E):Nt(E))}function ht(E){Qt(E),Y.length===0&&(v.domElement.releasePointerCapture(E.pointerId),v.domElement.removeEventListener("pointermove",Vt),v.domElement.removeEventListener("pointerup",ht)),v.dispatchEvent(Ze),u=_.NONE}function Rt(E){let pt;switch(E.button){case 0:pt=v.mouseButtons.LEFT;break;case 1:pt=v.mouseButtons.MIDDLE;break;case 2:pt=v.mouseButtons.RIGHT;break;default:pt=-1}switch(pt){case Me.DOLLY:if(v.enableZoom===!1)return;b(E),u=_.DOLLY;break;case Me.ROTATE:if(E.ctrlKey||E.metaKey||E.shiftKey){if(v.enablePan===!1)return;T(E),u=_.PAN}else{if(v.enableRotate===!1)return;q(E),u=_.ROTATE}break;case Me.PAN:if(E.ctrlKey||E.metaKey||E.shiftKey){if(v.enableRotate===!1)return;q(E),u=_.ROTATE}else{if(v.enablePan===!1)return;T(E),u=_.PAN}break;default:u=_.NONE}u!==_.NONE&&v.dispatchEvent(Oe)}function Nt(E){switch(u){case _.ROTATE:if(v.enableRotate===!1)return;g(E);break;case _.DOLLY:if(v.enableZoom===!1)return;x(E);break;case _.PAN:if(v.enablePan===!1)return;y(E);break}}function Pt(E){v.enabled===!1||v.enableZoom===!1||u!==_.NONE||(E.preventDefault(),v.dispatchEvent(Oe),M(E),v.dispatchEvent(Ze))}function Ft(E){v.enabled===!1||v.enablePan===!1||H(E)}function Mt(E){switch(le(E),Y.length){case 1:switch(v.touches.ONE){case Pe.ROTATE:if(v.enableRotate===!1)return;W(),u=_.TOUCH_ROTATE;break;case Pe.PAN:if(v.enablePan===!1)return;S(),u=_.TOUCH_PAN;break;default:u=_.NONE}break;case 2:switch(v.touches.TWO){case Pe.DOLLY_PAN:if(v.enableZoom===!1&&v.enablePan===!1)return;Z(),u=_.TOUCH_DOLLY_PAN;break;case Pe.DOLLY_ROTATE:if(v.enableZoom===!1&&v.enableRotate===!1)return;dt(),u=_.TOUCH_DOLLY_ROTATE;break;default:u=_.NONE}break;default:u=_.NONE}u!==_.NONE&&v.dispatchEvent(Oe)}function It(E){switch(le(E),u){case _.TOUCH_ROTATE:if(v.enableRotate===!1)return;ct(E),v.update();break;case _.TOUCH_PAN:if(v.enablePan===!1)return;at(E),v.update();break;case _.TOUCH_DOLLY_PAN:if(v.enableZoom===!1&&v.enablePan===!1)return;Q(E),v.update();break;case _.TOUCH_DOLLY_ROTATE:if(v.enableZoom===!1&&v.enableRotate===!1)return;Ct(E),v.update();break;default:u=_.NONE}}function St(E){v.enabled!==!1&&E.preventDefault()}function Ut(E){Y.push(E)}function Qt(E){delete V[E.pointerId];for(let pt=0;pt<Y.length;pt++)if(Y[pt].pointerId==E.pointerId){Y.splice(pt,1);return}}function le(E){let pt=V[E.pointerId];pt===void 0&&(pt=new ye,V[E.pointerId]=pt),pt.set(E.pageX,E.pageY)}function ce(E){const pt=E.pointerId===Y[0].pointerId?Y[1]:Y[0];return V[pt.pointerId]}v.domElement.addEventListener("contextmenu",St),v.domElement.addEventListener("pointerdown",mt),v.domElement.addEventListener("pointercancel",ht),v.domElement.addEventListener("wheel",Pt,{passive:!1}),this.update()}}var Ao=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function to(bt){return bt&&bt.__esModule&&Object.prototype.hasOwnProperty.call(bt,"default")?bt.default:bt}function Ne(bt){throw new Error('Could not dynamically require "'+bt+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var eo={exports:{}};(function(bt,xe){(function(d){bt.exports=d()})(function(){return function d(v,_,u){function e(l,o){if(!_[l]){if(!v[l]){var t=typeof Ne=="function"&&Ne;if(!o&&t)return t(l,!0);if(r)return r(l,!0);throw new Error("Cannot find module '"+l+"'")}var i=_[l]={exports:{}};v[l][0].call(i.exports,function(a){var s=v[l][1][a];return e(s||a)},i,i.exports,d,v,_,u)}return _[l].exports}for(var r=typeof Ne=="function"&&Ne,n=0;n<u.length;n++)e(u[n]);return e}({1:[function(d,v,_){v.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(d,v,_){v.exports={version:d("../package.json").version,AABB:d("./collision/AABB"),ArrayCollisionMatrix:d("./collision/ArrayCollisionMatrix"),Body:d("./objects/Body"),Box:d("./shapes/Box"),Broadphase:d("./collision/Broadphase"),Constraint:d("./constraints/Constraint"),ContactEquation:d("./equations/ContactEquation"),Narrowphase:d("./world/Narrowphase"),ConeTwistConstraint:d("./constraints/ConeTwistConstraint"),ContactMaterial:d("./material/ContactMaterial"),ConvexPolyhedron:d("./shapes/ConvexPolyhedron"),Cylinder:d("./shapes/Cylinder"),DistanceConstraint:d("./constraints/DistanceConstraint"),Equation:d("./equations/Equation"),EventTarget:d("./utils/EventTarget"),FrictionEquation:d("./equations/FrictionEquation"),GSSolver:d("./solver/GSSolver"),GridBroadphase:d("./collision/GridBroadphase"),Heightfield:d("./shapes/Heightfield"),HingeConstraint:d("./constraints/HingeConstraint"),LockConstraint:d("./constraints/LockConstraint"),Mat3:d("./math/Mat3"),Material:d("./material/Material"),NaiveBroadphase:d("./collision/NaiveBroadphase"),ObjectCollisionMatrix:d("./collision/ObjectCollisionMatrix"),Pool:d("./utils/Pool"),Particle:d("./shapes/Particle"),Plane:d("./shapes/Plane"),PointToPointConstraint:d("./constraints/PointToPointConstraint"),Quaternion:d("./math/Quaternion"),Ray:d("./collision/Ray"),RaycastVehicle:d("./objects/RaycastVehicle"),RaycastResult:d("./collision/RaycastResult"),RigidVehicle:d("./objects/RigidVehicle"),RotationalEquation:d("./equations/RotationalEquation"),RotationalMotorEquation:d("./equations/RotationalMotorEquation"),SAPBroadphase:d("./collision/SAPBroadphase"),SPHSystem:d("./objects/SPHSystem"),Shape:d("./shapes/Shape"),Solver:d("./solver/Solver"),Sphere:d("./shapes/Sphere"),SplitSolver:d("./solver/SplitSolver"),Spring:d("./objects/Spring"),Trimesh:d("./shapes/Trimesh"),Vec3:d("./math/Vec3"),Vec3Pool:d("./utils/Vec3Pool"),World:d("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(d,v,_){var u=d("../math/Vec3");d("../utils/Utils"),v.exports=e;function e(l){l=l||{},this.lowerBound=new u,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new u,l.upperBound&&this.upperBound.copy(l.upperBound)}var r=new u;e.prototype.setFromPoints=function(l,o,t,i){var a=this.lowerBound,s=this.upperBound,h=t;a.copy(l[0]),h&&h.vmult(a,a),s.copy(a);for(var c=1;c<l.length;c++){var p=l[c];h&&(h.vmult(p,r),p=r),p.x>s.x&&(s.x=p.x),p.x<a.x&&(a.x=p.x),p.y>s.y&&(s.y=p.y),p.y<a.y&&(a.y=p.y),p.z>s.z&&(s.z=p.z),p.z<a.z&&(a.z=p.z)}return o&&(o.vadd(a,a),o.vadd(s,s)),i&&(a.x-=i,a.y-=i,a.z-=i,s.x+=i,s.y+=i,s.z+=i),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var o=l.lowerBound.x;this.lowerBound.x>o&&(this.lowerBound.x=o);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var o=l.lowerBound.y;this.lowerBound.y>o&&(this.lowerBound.y=o);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var o=l.lowerBound.z;this.lowerBound.z>o&&(this.lowerBound.z=o);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,a=l.upperBound;return(i.x<=t.x&&t.x<=a.x||o.x<=a.x&&a.x<=t.x)&&(i.y<=t.y&&t.y<=a.y||o.y<=a.y&&a.y<=t.y)&&(i.z<=t.z&&t.z<=a.z||o.z<=a.z&&a.z<=t.z)},e.prototype.contains=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,a=l.upperBound;return o.x<=i.x&&t.x>=a.x&&o.y<=i.y&&t.y>=a.y&&o.z<=i.z&&t.z>=a.z},e.prototype.getCorners=function(l,o,t,i,a,s,h,c){var p=this.lowerBound,f=this.upperBound;l.copy(p),o.set(f.x,p.y,p.z),t.set(f.x,f.y,p.z),i.set(p.x,f.y,f.z),a.set(f.x,p.y,p.z),s.set(p.x,f.y,p.z),h.set(p.x,p.y,f.z),c.copy(f)};var n=[new u,new u,new u,new u,new u,new u,new u,new u];e.prototype.toLocalFrame=function(l,o){var t=n,i=t[0],a=t[1],s=t[2],h=t[3],c=t[4],p=t[5],f=t[6],w=t[7];this.getCorners(i,a,s,h,c,p,f,w);for(var m=0;m!==8;m++){var B=t[m];l.pointToLocal(B,B)}return o.setFromPoints(t)},e.prototype.toWorldFrame=function(l,o){var t=n,i=t[0],a=t[1],s=t[2],h=t[3],c=t[4],p=t[5],f=t[6],w=t[7];this.getCorners(i,a,s,h,c,p,f,w);for(var m=0;m!==8;m++){var B=t[m];l.pointToWorld(B,B)}return o.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(d,v,_){v.exports=u;function u(){this.matrix=[]}u.prototype.get=function(e,r){if(e=e.index,r=r.index,r>e){var n=r;r=e,e=n}return this.matrix[(e*(e+1)>>1)+r-1]},u.prototype.set=function(e,r,n){if(e=e.index,r=r.index,r>e){var l=r;r=e,e=l}this.matrix[(e*(e+1)>>1)+r-1]=n?1:0},u.prototype.reset=function(){for(var e=0,r=this.matrix.length;e!==r;e++)this.matrix[e]=0},u.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(d,v,_){var u=d("../objects/Body"),e=d("../math/Vec3"),r=d("../math/Quaternion");d("../shapes/Shape"),d("../shapes/Plane"),v.exports=n;function n(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}n.prototype.collisionPairs=function(h,c,p){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=u.STATIC|u.KINEMATIC;n.prototype.needBroadphaseCollision=function(h,c){return!(!(h.collisionFilterGroup&c.collisionFilterMask)||!(c.collisionFilterGroup&h.collisionFilterMask)||(h.type&l||h.sleepState===u.SLEEPING)&&(c.type&l||c.sleepState===u.SLEEPING))},n.prototype.intersectionTest=function(h,c,p,f){this.useBoundingBoxes?this.doBoundingBoxBroadphase(h,c,p,f):this.doBoundingSphereBroadphase(h,c,p,f)};var o=new e;new e,new r,new e,n.prototype.doBoundingSphereBroadphase=function(h,c,p,f){var w=o;c.position.vsub(h.position,w);var m=Math.pow(h.boundingRadius+c.boundingRadius,2),B=w.norm2();B<m&&(p.push(h),f.push(c))},n.prototype.doBoundingBoxBroadphase=function(h,c,p,f){h.aabbNeedsUpdate&&h.computeAABB(),c.aabbNeedsUpdate&&c.computeAABB(),h.aabb.overlaps(c.aabb)&&(p.push(h),f.push(c))};var t={keys:[]},i=[],a=[];n.prototype.makePairsUnique=function(h,c){for(var p=t,f=i,w=a,m=h.length,B=0;B!==m;B++)f[B]=h[B],w[B]=c[B];h.length=0,c.length=0;for(var B=0;B!==m;B++){var U=f[B].id,Y=w[B].id,V=U<Y?U+","+Y:Y+","+U;p[V]=B,p.keys.push(V)}for(var B=0;B!==p.keys.length;B++){var V=p.keys.pop(),D=p[V];h.push(f[D]),c.push(w[D]),delete p[V]}},n.prototype.setWorld=function(h){};var s=new e;n.boundingSphereCheck=function(h,c){var p=s;return h.position.vsub(c.position,p),Math.pow(h.shape.boundingSphereRadius+c.shape.boundingSphereRadius,2)>p.norm2()},n.prototype.aabbQuery=function(h,c,p){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(d,v,_){v.exports=n;var u=d("./Broadphase"),e=d("../math/Vec3"),r=d("../shapes/Shape");function n(o,t,i,a,s){u.apply(this),this.nx=i||10,this.ny=a||10,this.nz=s||10,this.aabbMin=o||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var h=this.nx*this.ny*this.nz;if(h<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=h,this.binLengths.length=h;for(var c=0;c<h;c++)this.bins[c]=[],this.binLengths[c]=0}n.prototype=new u,n.prototype.constructor=n;var l=new e;new e,n.prototype.collisionPairs=function(o,t,i){var a=o.numObjects(),s=o.bodies,H=this.aabbMax,M=this.aabbMin,h=this.nx,c=this.ny,p=this.nz,f=c*p,w=p,m=1,B=H.x,U=H.y,Y=H.z,V=M.x,D=M.y,R=M.z,A=h/(B-V),F=c/(U-D),I=p/(Y-R),$=(B-V)/h,J=(U-D)/c,vt=(Y-R)/p,z=Math.sqrt($*$+J*J+vt*vt)*.5,C=r.types,j=C.SPHERE,q=C.PLANE;C.BOX,C.COMPOUND,C.CONVEXPOLYHEDRON;for(var b=this.bins,T=this.binLengths,g=this.bins.length,x=0;x!==g;x++)T[x]=0;var y=Math.ceil,M=Math.min,H=Math.max;function W(le,ce,E,pt,zt,Wt,Dt){var _t=(le-V)*A|0,Gt=(ce-D)*F|0,Jt=(E-R)*I|0,he=y((pt-V)*A),$t=y((zt-D)*F),Ot=y((Wt-R)*I);_t<0?_t=0:_t>=h&&(_t=h-1),Gt<0?Gt=0:Gt>=c&&(Gt=c-1),Jt<0?Jt=0:Jt>=p&&(Jt=p-1),he<0?he=0:he>=h&&(he=h-1),$t<0?$t=0:$t>=c&&($t=c-1),Ot<0?Ot=0:Ot>=p&&(Ot=p-1),_t*=f,Gt*=w,Jt*=m,he*=f,$t*=w,Ot*=m;for(var jt=_t;jt<=he;jt+=f)for(var fe=Gt;fe<=$t;fe+=w)for(var ie=Jt;ie<=Ot;ie+=m){var ue=jt+fe+ie;b[ue][T[ue]++]=Dt}}for(var x=0;x!==a;x++){var S=s[x],L=S.shape;switch(L.type){case j:var Z=S.position.x,dt=S.position.y,ct=S.position.z,at=L.radius;W(Z-at,dt-at,ct-at,Z+at,dt+at,ct+at,S);break;case q:L.worldNormalNeedsUpdate&&L.computeWorldNormal(S.quaternion);var k=L.worldNormal,Q=V+$*.5-S.position.x,Ct=D+J*.5-S.position.y,mt=R+vt*.5-S.position.z,Vt=l;Vt.set(Q,Ct,mt);for(var ht=0,Rt=0;ht!==h;ht++,Rt+=f,Vt.y=Ct,Vt.x+=$)for(var Nt=0,Pt=0;Nt!==c;Nt++,Pt+=w,Vt.z=mt,Vt.y+=J)for(var Ft=0,Mt=0;Ft!==p;Ft++,Mt+=m,Vt.z+=vt)if(Vt.dot(k)<z){var It=Rt+Pt+Mt;b[It][T[It]++]=S}break;default:S.aabbNeedsUpdate&&S.computeAABB(),W(S.aabb.lowerBound.x,S.aabb.lowerBound.y,S.aabb.lowerBound.z,S.aabb.upperBound.x,S.aabb.upperBound.y,S.aabb.upperBound.z,S);break}}for(var x=0;x!==g;x++){var St=T[x];if(St>1)for(var Ut=b[x],ht=0;ht!==St;ht++)for(var S=Ut[ht],Nt=0;Nt!==ht;Nt++){var Qt=Ut[Nt];this.needBroadphaseCollision(S,Qt)&&this.intersectionTest(S,Qt,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(d,v,_){v.exports=r;var u=d("./Broadphase"),e=d("./AABB");function r(){u.apply(this)}r.prototype=new u,r.prototype.constructor=r,r.prototype.collisionPairs=function(n,l,o){var t=n.bodies,i=t.length,a,s,h,c;for(a=0;a!==i;a++)for(s=0;s!==a;s++)h=t[a],c=t[s],this.needBroadphaseCollision(h,c)&&this.intersectionTest(h,c,l,o)},new e,r.prototype.aabbQuery=function(n,l,o){o=o||[];for(var t=0;t<n.bodies.length;t++){var i=n.bodies[t];i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(l)&&o.push(i)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(d,v,_){v.exports=u;function u(){this.matrix={}}u.prototype.get=function(e,r){if(e=e.id,r=r.id,r>e){var n=r;r=e,e=n}return e+"-"+r in this.matrix},u.prototype.set=function(e,r,n){if(e=e.id,r=r.id,r>e){var l=r;r=e,e=l}n?this.matrix[e+"-"+r]=!0:delete this.matrix[e+"-"+r]},u.prototype.reset=function(){this.matrix={}},u.prototype.setNumObjects=function(e){}},{}],9:[function(d,v,_){v.exports=t;var u=d("../math/Vec3"),e=d("../math/Quaternion"),r=d("../math/Transform");d("../shapes/ConvexPolyhedron"),d("../shapes/Box");var n=d("../collision/RaycastResult"),l=d("../shapes/Shape"),o=d("../collision/AABB");function t(g,x){this.from=g?g.clone():new u,this.to=x?x.clone():new u,this._direction=new u,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new n,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var i=new o,a=[];t.prototype.intersectWorld=function(g,x){return this.mode=x.mode||t.ANY,this.result=x.result||new n,this.skipBackfaces=!!x.skipBackfaces,this.collisionFilterMask=typeof x.collisionFilterMask<"u"?x.collisionFilterMask:-1,this.collisionFilterGroup=typeof x.collisionFilterGroup<"u"?x.collisionFilterGroup:-1,x.from&&this.from.copy(x.from),x.to&&this.to.copy(x.to),this.callback=x.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(i),a.length=0,g.broadphase.aabbQuery(g,i,a),this.intersectBodies(a),this.hasHit};var s=new u,h=new u;t.pointInTriangle=c;function c(g,x,y,M){M.vsub(x,q),y.vsub(x,s),g.vsub(x,h);var H=q.dot(q),W=q.dot(s),S=q.dot(h),L=s.dot(s),Z=s.dot(h),dt,ct;return(dt=L*S-W*Z)>=0&&(ct=H*Z-W*S)>=0&&dt+ct<H*L-W*W}var p=new u,f=new e;t.prototype.intersectBody=function(g,x){x&&(this.result=x,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!g.collisionResponse)&&!(!(this.collisionFilterGroup&g.collisionFilterMask)||!(g.collisionFilterGroup&this.collisionFilterMask)))for(var M=p,H=f,W=0,S=g.shapes.length;W<S;W++){var L=g.shapes[W];if(!(y&&!L.collisionResponse)&&(g.quaternion.mult(g.shapeOrientations[W],H),g.quaternion.vmult(g.shapeOffsets[W],M),M.vadd(g.position,M),this.intersectShape(L,H,M,g),this.result._shouldStop))break}},t.prototype.intersectBodies=function(g,x){x&&(this.result=x,this._updateDirection());for(var y=0,M=g.length;!this.result._shouldStop&&y<M;y++)this.intersectBody(g[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(g,x,y,M){var H=this.from,W=T(H,this._direction,y);if(!(W>g.boundingSphereRadius)){var S=this[g.type];S&&S.call(this,g,x,y,M)}},new u,new u;var w=new u,m=new u,B=new u,U=new u;new u,new n,t.prototype.intersectBox=function(g,x,y,M){return this.intersectConvex(g.convexPolyhedronRepresentation,x,y,M)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(g,x,y,M){var H=this.from,W=this.to,S=this._direction,L=new u(0,0,1);x.vmult(L,L);var Z=new u;H.vsub(y,Z);var dt=Z.dot(L);W.vsub(y,Z);var ct=Z.dot(L);if(!(dt*ct>0)&&!(H.distanceTo(W)<dt)){var at=L.dot(S);if(!(Math.abs(at)<this.precision)){var k=new u,Q=new u,Ct=new u;H.vsub(y,k);var mt=-L.dot(k)/at;S.scale(mt,Q),H.vadd(Q,Ct),this.reportIntersection(L,Ct,g,M,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(g){var x=this.to,y=this.from;g.lowerBound.x=Math.min(x.x,y.x),g.lowerBound.y=Math.min(x.y,y.y),g.lowerBound.z=Math.min(x.z,y.z),g.upperBound.x=Math.max(x.x,y.x),g.upperBound.y=Math.max(x.y,y.y),g.upperBound.z=Math.max(x.z,y.z)};var Y={faceList:[0]};t.prototype.intersectHeightfield=function(g,x,y,M){g.data,g.elementSize;var H=new u,W=new t(this.from,this.to);r.pointToLocalFrame(y,x,W.from,W.from),r.pointToLocalFrame(y,x,W.to,W.to);var S=[],L=null,Z=null,dt=null,ct=null,at=g.getIndexOfPosition(W.from.x,W.from.y,S,!1);if(at&&(L=S[0],Z=S[1],dt=S[0],ct=S[1]),at=g.getIndexOfPosition(W.to.x,W.to.y,S,!1),at&&((L===null||S[0]<L)&&(L=S[0]),(dt===null||S[0]>dt)&&(dt=S[0]),(Z===null||S[1]<Z)&&(Z=S[1]),(ct===null||S[1]>ct)&&(ct=S[1])),L!==null){var k=[];g.getRectMinMax(L,Z,dt,ct,k),k[0],k[1];for(var Q=L;Q<=dt;Q++)for(var Ct=Z;Ct<=ct;Ct++){if(this.result._shouldStop||(g.getConvexTrianglePillar(Q,Ct,!1),r.pointToWorldFrame(y,x,g.pillarOffset,H),this.intersectConvex(g.pillarConvex,x,H,M,Y),this.result._shouldStop))return;g.getConvexTrianglePillar(Q,Ct,!0),r.pointToWorldFrame(y,x,g.pillarOffset,H),this.intersectConvex(g.pillarConvex,x,H,M,Y)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var V=new u,D=new u;t.prototype.intersectSphere=function(g,x,y,M){var H=this.from,W=this.to,S=g.radius,L=Math.pow(W.x-H.x,2)+Math.pow(W.y-H.y,2)+Math.pow(W.z-H.z,2),Z=2*((W.x-H.x)*(H.x-y.x)+(W.y-H.y)*(H.y-y.y)+(W.z-H.z)*(H.z-y.z)),dt=Math.pow(H.x-y.x,2)+Math.pow(H.y-y.y,2)+Math.pow(H.z-y.z,2)-Math.pow(S,2),ct=Math.pow(Z,2)-4*L*dt,at=V,k=D;if(!(ct<0))if(ct===0)H.lerp(W,ct,at),at.vsub(y,k),k.normalize(),this.reportIntersection(k,at,g,M,-1);else{var Q=(-Z-Math.sqrt(ct))/(2*L),Ct=(-Z+Math.sqrt(ct))/(2*L);if(Q>=0&&Q<=1&&(H.lerp(W,Q,at),at.vsub(y,k),k.normalize(),this.reportIntersection(k,at,g,M,-1)),this.result._shouldStop)return;Ct>=0&&Ct<=1&&(H.lerp(W,Ct,at),at.vsub(y,k),k.normalize(),this.reportIntersection(k,at,g,M,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var R=new u;new u,new u;var A=new u;t.prototype.intersectConvex=function(x,y,M,H,W){for(var S=R,L=A,Z=W&&W.faceList||null,dt=x.faces,ct=x.vertices,at=x.faceNormals,k=this._direction,Q=this.from,Ct=this.to,mt=Q.distanceTo(Ct),Vt=Z?Z.length:dt.length,ht=this.result,Rt=0;!ht._shouldStop&&Rt<Vt;Rt++){var Nt=Z?Z[Rt]:Rt,Pt=dt[Nt],Ft=at[Nt],Mt=y,It=M;L.copy(ct[Pt[0]]),Mt.vmult(L,L),L.vadd(It,L),L.vsub(Q,L),Mt.vmult(Ft,S);var St=k.dot(S);if(!(Math.abs(St)<this.precision)){var Ut=S.dot(L)/St;if(!(Ut<0)){k.mult(Ut,w),w.vadd(Q,w),m.copy(ct[Pt[0]]),Mt.vmult(m,m),It.vadd(m,m);for(var Qt=1;!ht._shouldStop&&Qt<Pt.length-1;Qt++){B.copy(ct[Pt[Qt]]),U.copy(ct[Pt[Qt+1]]),Mt.vmult(B,B),Mt.vmult(U,U),It.vadd(B,B),It.vadd(U,U);var le=w.distanceTo(Q);!(c(w,m,B,U)||c(w,B,m,U))||le>mt||this.reportIntersection(S,w,x,H,Nt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var F=new u,I=new u,$=new u,J=new u,vt=new u,z=new u;new o;var C=[],j=new r;t.prototype.intersectTrimesh=function(x,y,M,H,W){var S=F,L=C,Z=j,dt=A,ct=I,at=$,k=J,Q=z,Ct=vt;W&&W.faceList;var mt=x.indices;x.vertices,x.faceNormals;var Vt=this.from,ht=this.to,Rt=this._direction;Z.position.copy(M),Z.quaternion.copy(y),r.vectorToLocalFrame(M,y,Rt,ct),r.pointToLocalFrame(M,y,Vt,at),r.pointToLocalFrame(M,y,ht,k);var Nt=at.distanceSquared(k);x.tree.rayQuery(this,Z,L);for(var Pt=0,Ft=L.length;!this.result._shouldStop&&Pt!==Ft;Pt++){var Mt=L[Pt];x.getNormal(Mt,S),x.getVertex(mt[Mt*3],m),m.vsub(at,dt);var It=ct.dot(S),St=S.dot(dt)/It;if(!(St<0)){ct.scale(St,w),w.vadd(at,w),x.getVertex(mt[Mt*3+1],B),x.getVertex(mt[Mt*3+2],U);var Ut=w.distanceSquared(at);!(c(w,B,m,U)||c(w,m,B,U))||Ut>Nt||(r.vectorToWorldFrame(y,S,Ct),r.pointToWorldFrame(M,y,w,Q),this.reportIntersection(Ct,Q,x,H,Mt))}}L.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(g,x,y,M,H){var W=this.from,S=this.to,L=W.distanceTo(x),Z=this.result;if(!(this.skipBackfaces&&g.dot(this._direction)>0))switch(Z.hitFaceIndex=typeof H<"u"?H:-1,this.mode){case t.ALL:this.hasHit=!0,Z.set(W,S,g,x,y,M,L),Z.hasHit=!0,this.callback(Z);break;case t.CLOSEST:(L<Z.distance||!Z.hasHit)&&(this.hasHit=!0,Z.hasHit=!0,Z.set(W,S,g,x,y,M,L));break;case t.ANY:this.hasHit=!0,Z.hasHit=!0,Z.set(W,S,g,x,y,M,L),Z._shouldStop=!0;break}};var q=new u,b=new u;function T(g,x,y){y.vsub(g,q);var M=q.dot(x);x.mult(M,b),b.vadd(g,b);var H=y.distanceTo(b);return H}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(d,v,_){var u=d("../math/Vec3");v.exports=e;function e(){this.rayFromWorld=new u,this.rayToWorld=new u,this.hitNormalWorld=new u,this.hitPointWorld=new u,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(r,n,l,o,t,i,a){this.rayFromWorld.copy(r),this.rayToWorld.copy(n),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(o),this.shape=t,this.body=i,this.distance=a}},{"../math/Vec3":30}],11:[function(d,v,_){d("../shapes/Shape");var u=d("../collision/Broadphase");v.exports=e;function e(r){u.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var n=this.axisList;this._addBodyHandler=function(l){n.push(l.body)},this._removeBodyHandler=function(l){var o=n.indexOf(l.body);o!==-1&&n.splice(o,1)},r&&this.setWorld(r)}e.prototype=new u,e.prototype.setWorld=function(r){this.axisList.length=0;for(var n=0;n<r.bodies.length;n++)this.axisList.push(r.bodies[n]);r.removeEventListener("addBody",this._addBodyHandler),r.removeEventListener("removeBody",this._removeBodyHandler),r.addEventListener("addBody",this._addBodyHandler),r.addEventListener("removeBody",this._removeBodyHandler),this.world=r,this.dirty=!0},e.insertionSortX=function(r){for(var n=1,l=r.length;n<l;n++){for(var o=r[n],t=n-1;t>=0&&!(r[t].aabb.lowerBound.x<=o.aabb.lowerBound.x);t--)r[t+1]=r[t];r[t+1]=o}return r},e.insertionSortY=function(r){for(var n=1,l=r.length;n<l;n++){for(var o=r[n],t=n-1;t>=0&&!(r[t].aabb.lowerBound.y<=o.aabb.lowerBound.y);t--)r[t+1]=r[t];r[t+1]=o}return r},e.insertionSortZ=function(r){for(var n=1,l=r.length;n<l;n++){for(var o=r[n],t=n-1;t>=0&&!(r[t].aabb.lowerBound.z<=o.aabb.lowerBound.z);t--)r[t+1]=r[t];r[t+1]=o}return r},e.prototype.collisionPairs=function(r,n,l){var o=this.axisList,t=o.length,i=this.axisIndex,a,s;for(this.dirty&&(this.sortList(),this.dirty=!1),a=0;a!==t;a++){var h=o[a];for(s=a+1;s<t;s++){var c=o[s];if(this.needBroadphaseCollision(h,c)){if(!e.checkBounds(h,c,i))break;this.intersectionTest(h,c,n,l)}}}},e.prototype.sortList=function(){for(var r=this.axisList,n=this.axisIndex,l=r.length,o=0;o!==l;o++){var t=r[o];t.aabbNeedsUpdate&&t.computeAABB()}n===0?e.insertionSortX(r):n===1?e.insertionSortY(r):n===2&&e.insertionSortZ(r)},e.checkBounds=function(r,n,l){var o,t;l===0?(o=r.position.x,t=n.position.x):l===1?(o=r.position.y,t=n.position.y):l===2&&(o=r.position.z,t=n.position.z);var i=r.boundingRadius,a=n.boundingRadius,s=o+i,h=t-a;return h<s},e.prototype.autoDetectAxis=function(){for(var r=0,n=0,l=0,o=0,t=0,i=0,a=this.axisList,s=a.length,h=1/s,c=0;c!==s;c++){var p=a[c],f=p.position.x;r+=f,n+=f*f;var w=p.position.y;l+=w,o+=w*w;var m=p.position.z;t+=m,i+=m*m}var B=n-r*r*h,U=o-l*l*h,Y=i-t*t*h;B>U?B>Y?this.axisIndex=0:this.axisIndex=2:U>Y?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(r,n,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,t="x";o===1&&(t="y"),o===2&&(t="z");var i=this.axisList;n.lowerBound[t],n.upperBound[t];for(var a=0;a<i.length;a++){var s=i[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(n)&&l.push(s)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(d,v,_){v.exports=l,d("./Constraint");var u=d("./PointToPointConstraint"),e=d("../equations/ConeEquation"),r=d("../equations/RotationalEquation");d("../equations/ContactEquation");var n=d("../math/Vec3");function l(o,t,i){i=i||{};var a=typeof i.maxForce<"u"?i.maxForce:1e6,s=i.pivotA?i.pivotA.clone():new n,h=i.pivotB?i.pivotB.clone():new n;this.axisA=i.axisA?i.axisA.clone():new n,this.axisB=i.axisB?i.axisB.clone():new n,u.call(this,o,s,t,h,a),this.collideConnected=!!i.collideConnected,this.angle=typeof i.angle<"u"?i.angle:0;var c=this.coneEquation=new e(o,t,i),p=this.twistEquation=new r(o,t,i);this.twistAngle=typeof i.twistAngle<"u"?i.twistAngle:0,c.maxForce=0,c.minForce=-a,p.maxForce=0,p.minForce=-a,this.equations.push(c,p)}l.prototype=new u,l.constructor=l,new n,new n,l.prototype.update=function(){var o=this.bodyA,t=this.bodyB,i=this.coneEquation,a=this.twistEquation;u.prototype.update.call(this),o.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(a.axisA,a.axisA),o.vectorToWorldFrame(a.axisA,a.axisA),this.axisB.tangents(a.axisB,a.axisB),t.vectorToWorldFrame(a.axisB,a.axisB),i.angle=this.angle,a.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(d,v,_){v.exports=e;var u=d("../utils/Utils");function e(r,n,l){l=u.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=r,this.bodyB=n,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(r&&r.wakeUp(),n&&n.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var r=this.equations,n=0;n<r.length;n++)r[n].enabled=!0},e.prototype.disable=function(){for(var r=this.equations,n=0;n<r.length;n++)r[n].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(d,v,_){v.exports=r;var u=d("./Constraint"),e=d("../equations/ContactEquation");function r(n,l,o,t){u.call(this,n,l),typeof o>"u"&&(o=n.position.distanceTo(l.position)),typeof t>"u"&&(t=1e6),this.distance=o;var i=this.distanceEquation=new e(n,l);this.equations.push(i),i.minForce=-t,i.maxForce=t}r.prototype=new u,r.prototype.update=function(){var n=this.bodyA,l=this.bodyB,o=this.distanceEquation,t=this.distance*.5,i=o.ni;l.position.vsub(n.position,i),i.normalize(),i.mult(t,o.ri),i.mult(-t,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(d,v,_){v.exports=l,d("./Constraint");var u=d("./PointToPointConstraint"),e=d("../equations/RotationalEquation"),r=d("../equations/RotationalMotorEquation");d("../equations/ContactEquation");var n=d("../math/Vec3");function l(i,a,s){s=s||{};var h=typeof s.maxForce<"u"?s.maxForce:1e6,c=s.pivotA?s.pivotA.clone():new n,p=s.pivotB?s.pivotB.clone():new n;u.call(this,i,c,a,p,h);var f=this.axisA=s.axisA?s.axisA.clone():new n(1,0,0);f.normalize();var w=this.axisB=s.axisB?s.axisB.clone():new n(1,0,0);w.normalize();var m=this.rotationalEquation1=new e(i,a,s),B=this.rotationalEquation2=new e(i,a,s),U=this.motorEquation=new r(i,a,h);U.enabled=!1,this.equations.push(m,B,U)}l.prototype=new u,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(i){this.motorEquation.targetVelocity=i},l.prototype.setMotorMaxForce=function(i){this.motorEquation.maxForce=i,this.motorEquation.minForce=-i};var o=new n,t=new n;l.prototype.update=function(){var i=this.bodyA,a=this.bodyB,s=this.motorEquation,h=this.rotationalEquation1,c=this.rotationalEquation2,p=o,f=t,w=this.axisA,m=this.axisB;u.prototype.update.call(this),i.quaternion.vmult(w,p),a.quaternion.vmult(m,f),p.tangents(h.axisA,c.axisA),h.axisB.copy(f),c.axisB.copy(f),this.motorEquation.enabled&&(i.quaternion.vmult(this.axisA,s.axisA),a.quaternion.vmult(this.axisB,s.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(d,v,_){v.exports=n,d("./Constraint");var u=d("./PointToPointConstraint"),e=d("../equations/RotationalEquation");d("../equations/RotationalMotorEquation"),d("../equations/ContactEquation");var r=d("../math/Vec3");function n(l,o,t){t=t||{};var i=typeof t.maxForce<"u"?t.maxForce:1e6,a=new r,s=new r,h=new r;l.position.vadd(o.position,h),h.scale(.5,h),o.pointToLocalFrame(h,s),l.pointToLocalFrame(h,a),u.call(this,l,a,o,s,i);var c=this.rotationalEquation1=new e(l,o,t),p=this.rotationalEquation2=new e(l,o,t),f=this.rotationalEquation3=new e(l,o,t);this.equations.push(c,p,f)}n.prototype=new u,n.constructor=n,new r,new r,n.prototype.update=function(){var l=this.bodyA,o=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,i=this.rotationalEquation2,a=this.rotationalEquation3;u.prototype.update.call(this),l.vectorToWorldFrame(r.UNIT_X,t.axisA),o.vectorToWorldFrame(r.UNIT_Y,t.axisB),l.vectorToWorldFrame(r.UNIT_Y,i.axisA),o.vectorToWorldFrame(r.UNIT_Z,i.axisB),l.vectorToWorldFrame(r.UNIT_Z,a.axisA),o.vectorToWorldFrame(r.UNIT_X,a.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(d,v,_){v.exports=n;var u=d("./Constraint"),e=d("../equations/ContactEquation"),r=d("../math/Vec3");function n(l,o,t,i,a){u.call(this,l,t),a=typeof a<"u"?a:1e6,this.pivotA=o?o.clone():new r,this.pivotB=i?i.clone():new r;var s=this.equationX=new e(l,t),h=this.equationY=new e(l,t),c=this.equationZ=new e(l,t);this.equations.push(s,h,c),s.minForce=h.minForce=c.minForce=-a,s.maxForce=h.maxForce=c.maxForce=a,s.ni.set(1,0,0),h.ni.set(0,1,0),c.ni.set(0,0,1)}n.prototype=new u,n.prototype.update=function(){var l=this.bodyA,o=this.bodyB,t=this.equationX,i=this.equationY,a=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),o.quaternion.vmult(this.pivotB,t.rj),i.ri.copy(t.ri),i.rj.copy(t.rj),a.ri.copy(t.ri),a.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(d,v,_){v.exports=r;var u=d("../math/Vec3");d("../math/Mat3");var e=d("./Equation");function r(o,t,i){i=i||{};var a=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-a,a),this.axisA=i.axisA?i.axisA.clone():new u(1,0,0),this.axisB=i.axisB?i.axisB.clone():new u(0,1,0),this.angle=typeof i.angle<"u"?i.angle:0}r.prototype=new e,r.prototype.constructor=r;var n=new u,l=new u;r.prototype.computeB=function(o){var t=this.a,i=this.b,a=this.axisA,s=this.axisB,h=n,c=l,p=this.jacobianElementA,f=this.jacobianElementB;a.cross(s,h),s.cross(a,c),p.rotational.copy(c),f.rotational.copy(h);var w=Math.cos(this.angle)-a.dot(s),m=this.computeGW(),B=this.computeGiMf(),U=-w*t-m*i-o*B;return U}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(d,v,_){v.exports=r;var u=d("./Equation"),e=d("../math/Vec3");d("../math/Mat3");function r(c,p,f){f=typeof f<"u"?f:1e6,u.call(this,c,p,0,f),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}r.prototype=new u,r.prototype.constructor=r;var n=new e,l=new e,o=new e;r.prototype.computeB=function(c){var p=this.a,f=this.b,w=this.bi,m=this.bj,B=this.ri,U=this.rj,Y=n,V=l,D=w.velocity,R=w.angularVelocity;w.force,w.torque;var A=m.velocity,F=m.angularVelocity;m.force,m.torque;var I=o,$=this.jacobianElementA,J=this.jacobianElementB,vt=this.ni;B.cross(vt,Y),U.cross(vt,V),vt.negate($.spatial),Y.negate($.rotational),J.spatial.copy(vt),J.rotational.copy(V),I.copy(m.position),I.vadd(U,I),I.vsub(w.position,I),I.vsub(B,I);var z=vt.dot(I),C=this.restitution+1,j=C*A.dot(vt)-C*D.dot(vt)+F.dot(V)-R.dot(Y),q=this.computeGiMf(),b=-z*p-j*f-c*q;return b};var t=new e,i=new e,a=new e,s=new e,h=new e;r.prototype.getImpactVelocityAlongNormal=function(){var c=t,p=i,f=a,w=s,m=h;return this.bi.position.vadd(this.ri,f),this.bj.position.vadd(this.rj,w),this.bi.getVelocityAtWorldPoint(f,c),this.bj.getVelocityAtWorldPoint(w,p),c.vsub(p,m),this.ni.dot(m)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(d,v,_){v.exports=r;var u=d("../math/JacobianElement"),e=d("../math/Vec3");function r(h,c,p,f){this.id=r.id++,this.minForce=typeof p>"u"?-1e6:p,this.maxForce=typeof f>"u"?1e6:f,this.bi=h,this.bj=c,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new u,this.jacobianElementB=new u,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(h,c,p){var f=c,w=h,m=p;this.a=4/(m*(1+4*f)),this.b=4*f/(1+4*f),this.eps=4/(m*m*w*(1+4*f))},r.prototype.computeB=function(h,c,p){var f=this.computeGW(),w=this.computeGq(),m=this.computeGiMf();return-w*h-f*c-m*p},r.prototype.computeGq=function(){var h=this.jacobianElementA,c=this.jacobianElementB,p=this.bi,f=this.bj,w=p.position,m=f.position;return h.spatial.dot(w)+c.spatial.dot(m)};var n=new e;r.prototype.computeGW=function(){var h=this.jacobianElementA,c=this.jacobianElementB,p=this.bi,f=this.bj,w=p.velocity,m=f.velocity,B=p.angularVelocity||n,U=f.angularVelocity||n;return h.multiplyVectors(w,B)+c.multiplyVectors(m,U)},r.prototype.computeGWlambda=function(){var h=this.jacobianElementA,c=this.jacobianElementB,p=this.bi,f=this.bj,w=p.vlambda,m=f.vlambda,B=p.wlambda||n,U=f.wlambda||n;return h.multiplyVectors(w,B)+c.multiplyVectors(m,U)};var l=new e,o=new e,t=new e,i=new e;r.prototype.computeGiMf=function(){var h=this.jacobianElementA,c=this.jacobianElementB,p=this.bi,f=this.bj,w=p.force,m=p.torque,B=f.force,U=f.torque,Y=p.invMassSolve,V=f.invMassSolve;return p.invInertiaWorldSolve?p.invInertiaWorldSolve.vmult(m,t):t.set(0,0,0),f.invInertiaWorldSolve?f.invInertiaWorldSolve.vmult(U,i):i.set(0,0,0),w.mult(Y,l),B.mult(V,o),h.multiplyVectors(l,t)+c.multiplyVectors(o,i)};var a=new e;r.prototype.computeGiMGt=function(){var h=this.jacobianElementA,c=this.jacobianElementB,p=this.bi,f=this.bj,w=p.invMassSolve,m=f.invMassSolve,B=p.invInertiaWorldSolve,U=f.invInertiaWorldSolve,Y=w+m;return B&&(B.vmult(h.rotational,a),Y+=a.dot(h.rotational)),U&&(U.vmult(c.rotational,a),Y+=a.dot(c.rotational)),Y};var s=new e;new e,new e,new e,new e,new e,r.prototype.addToWlambda=function(h){var c=this.jacobianElementA,p=this.jacobianElementB,f=this.bi,w=this.bj,m=s;c.spatial.mult(f.invMassSolve*h,m),f.vlambda.vadd(m,f.vlambda),p.spatial.mult(w.invMassSolve*h,m),w.vlambda.vadd(m,w.vlambda),f.invInertiaWorldSolve&&(f.invInertiaWorldSolve.vmult(c.rotational,m),m.mult(h,m),f.wlambda.vadd(m,f.wlambda)),w.invInertiaWorldSolve&&(w.invInertiaWorldSolve.vmult(p.rotational,m),m.mult(h,m),w.wlambda.vadd(m,w.wlambda))},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(d,v,_){v.exports=r;var u=d("./Equation"),e=d("../math/Vec3");d("../math/Mat3");function r(o,t,i){u.call(this,o,t,-i,i),this.ri=new e,this.rj=new e,this.t=new e}r.prototype=new u,r.prototype.constructor=r;var n=new e,l=new e;r.prototype.computeB=function(o){this.a;var t=this.b;this.bi,this.bj;var i=this.ri,a=this.rj,s=n,h=l,c=this.t;i.cross(c,s),a.cross(c,h);var p=this.jacobianElementA,f=this.jacobianElementB;c.negate(p.spatial),s.negate(p.rotational),f.spatial.copy(c),f.rotational.copy(h);var w=this.computeGW(),m=this.computeGiMf(),B=-w*t-o*m;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(d,v,_){v.exports=r;var u=d("../math/Vec3");d("../math/Mat3");var e=d("./Equation");function r(o,t,i){i=i||{};var a=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-a,a),this.axisA=i.axisA?i.axisA.clone():new u(1,0,0),this.axisB=i.axisB?i.axisB.clone():new u(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new e,r.prototype.constructor=r;var n=new u,l=new u;r.prototype.computeB=function(o){var t=this.a,i=this.b,a=this.axisA,s=this.axisB,h=n,c=l,p=this.jacobianElementA,f=this.jacobianElementB;a.cross(s,h),s.cross(a,c),p.rotational.copy(c),f.rotational.copy(h);var w=Math.cos(this.maxAngle)-a.dot(s),m=this.computeGW(),B=this.computeGiMf(),U=-w*t-m*i-o*B;return U}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(d,v,_){v.exports=r;var u=d("../math/Vec3");d("../math/Mat3");var e=d("./Equation");function r(n,l,o){o=typeof o<"u"?o:1e6,e.call(this,n,l,-o,o),this.axisA=new u,this.axisB=new u,this.targetVelocity=0}r.prototype=new e,r.prototype.constructor=r,r.prototype.computeB=function(n){this.a;var l=this.b;this.bi,this.bj;var o=this.axisA,t=this.axisB,i=this.jacobianElementA,a=this.jacobianElementB;i.rotational.copy(o),t.negate(a.rotational);var s=this.computeGW()-this.targetVelocity,h=this.computeGiMf(),c=-s*l-n*h;return c}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(d,v,_){var u=d("../utils/Utils");v.exports=e;function e(r,n,l){l=u.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[r,n],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(d,v,_){v.exports=u;function u(e){var r="";e=e||{},typeof e=="string"?(r=e,e={}):typeof e=="object"&&(r=""),this.name=r,this.id=u.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}u.idCounter=0},{}],26:[function(d,v,_){v.exports=e;var u=d("./Vec3");function e(){this.spatial=new u,this.rotational=new u}e.prototype.multiplyElement=function(r){return r.spatial.dot(this.spatial)+r.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(r,n){return r.dot(this.spatial)+n.dot(this.rotational)}},{"./Vec3":30}],27:[function(d,v,_){v.exports=e;var u=d("./Vec3");function e(r){r?this.elements=r:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var r=this.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1},e.prototype.setZero=function(){var r=this.elements;r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0},e.prototype.setTrace=function(r){var n=this.elements;n[0]=r.x,n[4]=r.y,n[8]=r.z},e.prototype.getTrace=function(n){var n=n||new u,l=this.elements;n.x=l[0],n.y=l[4],n.z=l[8]},e.prototype.vmult=function(r,n){n=n||new u;var l=this.elements,o=r.x,t=r.y,i=r.z;return n.x=l[0]*o+l[1]*t+l[2]*i,n.y=l[3]*o+l[4]*t+l[5]*i,n.z=l[6]*o+l[7]*t+l[8]*i,n},e.prototype.smult=function(r){for(var n=0;n<this.elements.length;n++)this.elements[n]*=r},e.prototype.mmult=function(r,n){for(var l=n||new e,o=0;o<3;o++)for(var t=0;t<3;t++){for(var i=0,a=0;a<3;a++)i+=r.elements[o+a*3]*this.elements[a+t*3];l.elements[o+t*3]=i}return l},e.prototype.scale=function(r,n){n=n||new e;for(var l=this.elements,o=n.elements,t=0;t!==3;t++)o[3*t+0]=r.x*l[3*t+0],o[3*t+1]=r.y*l[3*t+1],o[3*t+2]=r.z*l[3*t+2];return n},e.prototype.solve=function(r,n){n=n||new u;for(var l=3,o=4,t=[],i=0;i<l*o;i++)t.push(0);var i,a;for(i=0;i<3;i++)for(a=0;a<3;a++)t[i+o*a]=this.elements[i+3*a];t[3+4*0]=r.x,t[3+4*1]=r.y,t[3+4*2]=r.z;var s=3,h=s,c,p=4,f;do{if(i=h-s,t[i+o*i]===0){for(a=i+1;a<h;a++)if(t[i+o*a]!==0){c=p;do f=p-c,t[f+o*i]+=t[f+o*a];while(--c);break}}if(t[i+o*i]!==0)for(a=i+1;a<h;a++){var w=t[i+o*a]/t[i+o*i];c=p;do f=p-c,t[f+o*a]=f<=i?0:t[f+o*a]-t[f+o*i]*w;while(--c)}}while(--s);if(n.z=t[2*o+3]/t[2*o+2],n.y=(t[1*o+3]-t[1*o+2]*n.z)/t[1*o+1],n.x=(t[0*o+3]-t[0*o+2]*n.z-t[0*o+1]*n.y)/t[0*o+0],isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||n.x===1/0||n.y===1/0||n.z===1/0)throw"Could not solve equation! Got x=["+n.toString()+"], b=["+r.toString()+"], A=["+this.toString()+"]";return n},e.prototype.e=function(r,n,l){if(l===void 0)return this.elements[n+3*r];this.elements[n+3*r]=l},e.prototype.copy=function(r){for(var n=0;n<r.elements.length;n++)this.elements[n]=r.elements[n];return this},e.prototype.toString=function(){for(var r="",n=",",l=0;l<9;l++)r+=this.elements[l]+n;return r},e.prototype.reverse=function(r){r=r||new e;for(var n=3,l=6,o=[],t=0;t<n*l;t++)o.push(0);var t,i;for(t=0;t<3;t++)for(i=0;i<3;i++)o[t+l*i]=this.elements[t+3*i];o[3+6*0]=1,o[3+6*1]=0,o[3+6*2]=0,o[4+6*0]=0,o[4+6*1]=1,o[4+6*2]=0,o[5+6*0]=0,o[5+6*1]=0,o[5+6*2]=1;var a=3,s=a,h,c=l,p;do{if(t=s-a,o[t+l*t]===0){for(i=t+1;i<s;i++)if(o[t+l*i]!==0){h=c;do p=c-h,o[p+l*t]+=o[p+l*i];while(--h);break}}if(o[t+l*t]!==0)for(i=t+1;i<s;i++){var f=o[t+l*i]/o[t+l*t];h=c;do p=c-h,o[p+l*i]=p<=t?0:o[p+l*i]-o[p+l*t]*f;while(--h)}}while(--a);t=2;do{i=t-1;do{var f=o[t+l*i]/o[t+l*t];h=l;do p=l-h,o[p+l*i]=o[p+l*i]-o[p+l*t]*f;while(--h)}while(i--)}while(--t);t=2;do{var f=1/o[t+l*t];h=l;do p=l-h,o[p+l*t]=o[p+l*t]*f;while(--h)}while(t--);t=2;do{i=2;do{if(p=o[n+i+l*t],isNaN(p)||p===1/0)throw"Could not reverse! A=["+this.toString()+"]";r.e(t,i,p)}while(i--)}while(t--);return r},e.prototype.setRotationFromQuaternion=function(r){var n=r.x,l=r.y,o=r.z,t=r.w,i=n+n,a=l+l,s=o+o,h=n*i,c=n*a,p=n*s,f=l*a,w=l*s,m=o*s,B=t*i,U=t*a,Y=t*s,V=this.elements;return V[3*0+0]=1-(f+m),V[3*0+1]=c-Y,V[3*0+2]=p+U,V[3*1+0]=c+Y,V[3*1+1]=1-(h+m),V[3*1+2]=w-B,V[3*2+0]=p-U,V[3*2+1]=w+B,V[3*2+2]=1-(h+f),this},e.prototype.transpose=function(r){r=r||new e;for(var n=r.elements,l=this.elements,o=0;o!==3;o++)for(var t=0;t!==3;t++)n[3*o+t]=l[3*t+o];return r}},{"./Vec3":30}],28:[function(d,v,_){v.exports=e;var u=d("./Vec3");function e(i,a,s,h){this.x=i!==void 0?i:0,this.y=a!==void 0?a:0,this.z=s!==void 0?s:0,this.w=h!==void 0?h:1}e.prototype.set=function(i,a,s,h){this.x=i,this.y=a,this.z=s,this.w=h},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(i,a){var s=Math.sin(a*.5);this.x=i.x*s,this.y=i.y*s,this.z=i.z*s,this.w=Math.cos(a*.5)},e.prototype.toAxisAngle=function(i){i=i||new u,this.normalize();var a=2*Math.acos(this.w),s=Math.sqrt(1-this.w*this.w);return s<.001?(i.x=this.x,i.y=this.y,i.z=this.z):(i.x=this.x/s,i.y=this.y/s,i.z=this.z/s),[i,a]};var r=new u,n=new u;e.prototype.setFromVectors=function(i,a){if(i.isAntiparallelTo(a)){var s=r,h=n;i.tangents(s,h),this.setFromAxisAngle(s,Math.PI)}else{var c=i.cross(a);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(Math.pow(i.norm(),2)*Math.pow(a.norm(),2))+i.dot(a),this.normalize()}};var l=new u,o=new u,t=new u;e.prototype.mult=function(i,a){a=a||new e;var s=this.w,h=l,c=o,p=t;return h.set(this.x,this.y,this.z),c.set(i.x,i.y,i.z),a.w=s*i.w-h.dot(c),h.cross(c,p),a.x=s*c.x+i.w*h.x+p.x,a.y=s*c.y+i.w*h.y+p.y,a.z=s*c.z+i.w*h.z+p.z,a},e.prototype.inverse=function(i){var a=this.x,s=this.y,h=this.z,c=this.w;i=i||new e,this.conjugate(i);var p=1/(a*a+s*s+h*h+c*c);return i.x*=p,i.y*=p,i.z*=p,i.w*=p,i},e.prototype.conjugate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i.w=this.w,i},e.prototype.normalize=function(){var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(i=1/i,this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.normalizeFast=function(){var i=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.vmult=function(i,a){a=a||new u;var s=i.x,h=i.y,c=i.z,p=this.x,f=this.y,w=this.z,m=this.w,B=m*s+f*c-w*h,U=m*h+w*s-p*c,Y=m*c+p*h-f*s,V=-p*s-f*h-w*c;return a.x=B*m+V*-p+U*-w-Y*-f,a.y=U*m+V*-f+Y*-p-B*-w,a.z=Y*m+V*-w+B*-f-U*-p,a},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},e.prototype.toEuler=function(i,a){a=a||"YZX";var s,h,c,p=this.x,f=this.y,w=this.z,m=this.w;switch(a){case"YZX":var B=p*f+w*m;if(B>.499&&(s=2*Math.atan2(p,m),h=Math.PI/2,c=0),B<-.499&&(s=-2*Math.atan2(p,m),h=-Math.PI/2,c=0),isNaN(s)){var U=p*p,Y=f*f,V=w*w;s=Math.atan2(2*f*m-2*p*w,1-2*Y-2*V),h=Math.asin(2*B),c=Math.atan2(2*p*m-2*f*w,1-2*U-2*V)}break;default:throw new Error("Euler order "+a+" not supported yet.")}i.y=s,i.z=h,i.x=c},e.prototype.setFromEuler=function(i,a,s,h){h=h||"XYZ";var c=Math.cos(i/2),p=Math.cos(a/2),f=Math.cos(s/2),w=Math.sin(i/2),m=Math.sin(a/2),B=Math.sin(s/2);return h==="XYZ"?(this.x=w*p*f+c*m*B,this.y=c*m*f-w*p*B,this.z=c*p*B+w*m*f,this.w=c*p*f-w*m*B):h==="YXZ"?(this.x=w*p*f+c*m*B,this.y=c*m*f-w*p*B,this.z=c*p*B-w*m*f,this.w=c*p*f+w*m*B):h==="ZXY"?(this.x=w*p*f-c*m*B,this.y=c*m*f+w*p*B,this.z=c*p*B+w*m*f,this.w=c*p*f-w*m*B):h==="ZYX"?(this.x=w*p*f-c*m*B,this.y=c*m*f+w*p*B,this.z=c*p*B-w*m*f,this.w=c*p*f+w*m*B):h==="YZX"?(this.x=w*p*f+c*m*B,this.y=c*m*f+w*p*B,this.z=c*p*B-w*m*f,this.w=c*p*f-w*m*B):h==="XZY"&&(this.x=w*p*f-c*m*B,this.y=c*m*f-w*p*B,this.z=c*p*B+w*m*f,this.w=c*p*f+w*m*B),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(d,v,_){var u=d("./Vec3"),e=d("./Quaternion");v.exports=r;function r(l){l=l||{},this.position=new u,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var n=new e;r.pointToLocalFrame=function(l,o,t,a){var a=a||new u;return t.vsub(l,a),o.conjugate(n),n.vmult(a,a),a},r.prototype.pointToLocal=function(l,o){return r.pointToLocalFrame(this.position,this.quaternion,l,o)},r.pointToWorldFrame=function(l,o,t,a){var a=a||new u;return o.vmult(t,a),a.vadd(l,a),a},r.prototype.pointToWorld=function(l,o){return r.pointToWorldFrame(this.position,this.quaternion,l,o)},r.prototype.vectorToWorldFrame=function(l,t){var t=t||new u;return this.quaternion.vmult(l,t),t},r.vectorToWorldFrame=function(l,o,t){return l.vmult(o,t),t},r.vectorToLocalFrame=function(l,o,t,a){var a=a||new u;return o.w*=-1,o.vmult(t,a),o.w*=-1,a}},{"./Quaternion":28,"./Vec3":30}],30:[function(d,v,_){v.exports=e;var u=d("./Mat3");function e(o,t,i){this.x=o||0,this.y=t||0,this.z=i||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(o,t){var i=o.x,a=o.y,s=o.z,h=this.x,c=this.y,p=this.z;return t=t||new e,t.x=c*s-p*a,t.y=p*i-h*s,t.z=h*a-c*i,t},e.prototype.set=function(o,t,i){return this.x=o,this.y=t,this.z=i,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(o,t){if(t)t.x=o.x+this.x,t.y=o.y+this.y,t.z=o.z+this.z;else return new e(this.x+o.x,this.y+o.y,this.z+o.z)},e.prototype.vsub=function(o,t){if(t)t.x=this.x-o.x,t.y=this.y-o.y,t.z=this.z-o.z;else return new e(this.x-o.x,this.y-o.y,this.z-o.z)},e.prototype.crossmat=function(){return new u([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var o=this.x,t=this.y,i=this.z,a=Math.sqrt(o*o+t*t+i*i);if(a>0){var s=1/a;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return a},e.prototype.unit=function(o){o=o||new e;var t=this.x,i=this.y,a=this.z,s=Math.sqrt(t*t+i*i+a*a);return s>0?(s=1/s,o.x=t*s,o.y=i*s,o.z=a*s):(o.x=1,o.y=0,o.z=0),o},e.prototype.norm=function(){var o=this.x,t=this.y,i=this.z;return Math.sqrt(o*o+t*t+i*i)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(o){var t=this.x,i=this.y,a=this.z,s=o.x,h=o.y,c=o.z;return Math.sqrt((s-t)*(s-t)+(h-i)*(h-i)+(c-a)*(c-a))},e.prototype.distanceSquared=function(o){var t=this.x,i=this.y,a=this.z,s=o.x,h=o.y,c=o.z;return(s-t)*(s-t)+(h-i)*(h-i)+(c-a)*(c-a)},e.prototype.mult=function(o,t){t=t||new e;var i=this.x,a=this.y,s=this.z;return t.x=o*i,t.y=o*a,t.z=o*s,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(o){return this.x*o.x+this.y*o.y+this.z*o.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o};var r=new e,n=new e;e.prototype.tangents=function(o,t){var i=this.norm();if(i>0){var a=r,s=1/i;a.set(this.x*s,this.y*s,this.z*s);var h=n;Math.abs(a.x)<.9?(h.set(1,0,0),a.cross(h,o)):(h.set(0,1,0),a.cross(h,o)),a.cross(o,t)}else o.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this},e.prototype.lerp=function(o,t,i){var a=this.x,s=this.y,h=this.z;i.x=a+(o.x-a)*t,i.y=s+(o.y-s)*t,i.z=h+(o.z-h)*t},e.prototype.almostEquals=function(o,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-o.x)>t||Math.abs(this.y-o.y)>t||Math.abs(this.z-o.z)>t)},e.prototype.almostZero=function(o){return o===void 0&&(o=1e-6),!(Math.abs(this.x)>o||Math.abs(this.y)>o||Math.abs(this.z)>o)};var l=new e;e.prototype.isAntiparallelTo=function(o,t){return this.negate(l),l.almostEquals(o,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(d,v,_){v.exports=t;var u=d("../utils/EventTarget");d("../shapes/Shape");var e=d("../math/Vec3"),r=d("../math/Mat3"),n=d("../math/Quaternion");d("../material/Material");var l=d("../collision/AABB"),o=d("../shapes/Box");function t(A){A=A||{},u.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof A.collisionFilterGroup=="number"?A.collisionFilterGroup:1,this.collisionFilterMask=typeof A.collisionFilterMask=="number"?A.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,A.position&&this.position.copy(A.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,A.velocity&&this.velocity.copy(A.velocity),this.initVelocity=new e,this.force=new e;var F=typeof A.mass=="number"?A.mass:0;this.mass=F,this.invMass=F>0?1/F:0,this.material=A.material||null,this.linearDamping=typeof A.linearDamping=="number"?A.linearDamping:.01,this.type=F<=0?t.STATIC:t.DYNAMIC,typeof A.type==typeof t.STATIC&&(this.type=A.type),this.allowSleep=typeof A.allowSleep<"u"?A.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof A.sleepSpeedLimit<"u"?A.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof A.sleepTimeLimit<"u"?A.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new n,A.quaternion&&this.quaternion.copy(A.quaternion),this.initQuaternion=new n,this.angularVelocity=new e,A.angularVelocity&&this.angularVelocity.copy(A.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new n,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new r,this.fixedRotation=typeof A.fixedRotation<"u"?A.fixedRotation:!1,this.angularDamping=typeof A.angularDamping<"u"?A.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,A.shape&&this.addShape(A.shape),this.updateMassProperties()}t.prototype=new u,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var A=this.sleepState;this.sleepState=0,A===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(A){if(this.allowSleep){var F=this.sleepState,I=this.velocity.norm2()+this.angularVelocity.norm2(),$=Math.pow(this.sleepSpeedLimit,2);F===t.AWAKE&&I<$?(this.sleepState=t.SLEEPY,this.timeLastSleepy=A,this.dispatchEvent(t.sleepyEvent)):F===t.SLEEPY&&I>$?this.wakeUp():F===t.SLEEPY&&A-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(A,I){var I=I||new e;return A.vsub(this.position,I),this.quaternion.conjugate().vmult(I,I),I},t.prototype.vectorToLocalFrame=function(A,I){var I=I||new e;return this.quaternion.conjugate().vmult(A,I),I},t.prototype.pointToWorldFrame=function(A,I){var I=I||new e;return this.quaternion.vmult(A,I),I.vadd(this.position,I),I},t.prototype.vectorToWorldFrame=function(A,I){var I=I||new e;return this.quaternion.vmult(A,I),I};var i=new e,a=new n;t.prototype.addShape=function(A,F,I){var $=new e,J=new n;return F&&$.copy(F),I&&J.copy(I),this.shapes.push(A),this.shapeOffsets.push($),this.shapeOrientations.push(J),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var A=this.shapes,F=this.shapeOffsets,I=A.length,$=0,J=0;J!==I;J++){var vt=A[J];vt.updateBoundingSphereRadius();var z=F[J].norm(),C=vt.boundingSphereRadius;z+C>$&&($=z+C)}this.boundingRadius=$};var s=new l;t.prototype.computeAABB=function(){for(var A=this.shapes,F=this.shapeOffsets,I=this.shapeOrientations,$=A.length,J=i,vt=a,z=this.quaternion,C=this.aabb,j=s,q=0;q!==$;q++){var b=A[q];I[q].mult(z,vt),vt.vmult(F[q],J),J.vadd(this.position,J),b.calculateWorldAABB(J,vt,j.lowerBound,j.upperBound),q===0?C.copy(j):C.extend(j)}this.aabbNeedsUpdate=!1};var h=new r,c=new r;new r,t.prototype.updateInertiaWorld=function(A){var F=this.invInertia;if(!(F.x===F.y&&F.y===F.z&&!A)){var I=h,$=c;I.setRotationFromQuaternion(this.quaternion),I.transpose($),I.scale(F,I),I.mmult($,this.invInertiaWorld)}};var p=new e,f=new e;t.prototype.applyForce=function(A,F){if(this.type===t.DYNAMIC){var I=p;F.vsub(this.position,I);var $=f;I.cross(A,$),this.force.vadd(A,this.force),this.torque.vadd($,this.torque)}};var w=new e,m=new e;t.prototype.applyLocalForce=function(A,F){if(this.type===t.DYNAMIC){var I=w,$=m;this.vectorToWorldFrame(A,I),this.pointToWorldFrame(F,$),this.applyForce(I,$)}};var B=new e,U=new e,Y=new e;t.prototype.applyImpulse=function(A,F){if(this.type===t.DYNAMIC){var I=B;F.vsub(this.position,I);var $=U;$.copy(A),$.mult(this.invMass,$),this.velocity.vadd($,this.velocity);var J=Y;I.cross(A,J),this.invInertiaWorld.vmult(J,J),this.angularVelocity.vadd(J,this.angularVelocity)}};var V=new e,D=new e;t.prototype.applyLocalImpulse=function(A,F){if(this.type===t.DYNAMIC){var I=V,$=D;this.vectorToWorldFrame(A,I),this.pointToWorldFrame(F,$),this.applyImpulse(I,$)}};var R=new e;t.prototype.updateMassProperties=function(){var A=R;this.invMass=this.mass>0?1/this.mass:0;var F=this.inertia,I=this.fixedRotation;this.computeAABB(),A.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),o.calculateInertia(A,this.mass,F),this.invInertia.set(F.x>0&&!I?1/F.x:0,F.y>0&&!I?1/F.y:0,F.z>0&&!I?1/F.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(A,F){var I=new e;return A.vsub(this.position,I),this.angularVelocity.cross(I,F),this.velocity.vadd(F,F),F}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(d,v,_){d("./Body");var u=d("../math/Vec3"),e=d("../math/Quaternion");d("../collision/RaycastResult");var r=d("../collision/Ray"),n=d("../objects/WheelInfo");v.exports=l;function l(z){this.chassisBody=z.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof z.indexRightAxis<"u"?z.indexRightAxis:1,this.indexForwardAxis=typeof z.indexForwardAxis<"u"?z.indexForwardAxis:0,this.indexUpAxis=typeof z.indexUpAxis<"u"?z.indexUpAxis:2}new u,new u,new u;var o=new u,t=new u,i=new u;new r,l.prototype.addWheel=function(z){z=z||{};var C=new n(z),j=this.wheelInfos.length;return this.wheelInfos.push(C),j},l.prototype.setSteeringValue=function(z,C){var j=this.wheelInfos[C];j.steering=z},new u,l.prototype.applyEngineForce=function(z,C){this.wheelInfos[C].engineForce=z},l.prototype.setBrake=function(z,C){this.wheelInfos[C].brake=z},l.prototype.addToWorld=function(z){this.constraints,z.add(this.chassisBody);var C=this;this.preStepCallback=function(){C.updateVehicle(z.dt)},z.addEventListener("preStep",this.preStepCallback),this.world=z},l.prototype.getVehicleAxisWorld=function(z,C){C.set(z===0?1:0,z===1?1:0,z===2?1:0),this.chassisBody.vectorToWorldFrame(C,C)},l.prototype.updateVehicle=function(z){for(var C=this.wheelInfos,j=C.length,q=this.chassisBody,b=0;b<j;b++)this.updateWheelTransform(b);this.currentVehicleSpeedKmHour=3.6*q.velocity.norm();var T=new u;this.getVehicleAxisWorld(this.indexForwardAxis,T),T.dot(q.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var b=0;b<j;b++)this.castRay(C[b]);this.updateSuspension(z);for(var g=new u,x=new u,b=0;b<j;b++){var y=C[b],M=y.suspensionForce;M>y.maxSuspensionForce&&(M=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(M*z,g),y.raycastResult.hitPointWorld.vsub(q.position,x),q.applyImpulse(g,y.raycastResult.hitPointWorld)}this.updateFriction(z);var H=new u,W=new u,S=new u;for(b=0;b<j;b++){var y=C[b];q.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,S);var L=1;switch(this.indexUpAxis){case 1:L=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,W);var Z=W.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(Z,H),W.vsub(H,W);var dt=W.dot(S);y.deltaRotation=L*dt*z/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*z),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(z){for(var C=this.chassisBody,j=C.mass,q=this.wheelInfos,b=q.length,T=0;T<b;T++){var g=q[T];if(g.isInContact){var x,y=g.suspensionRestLength,M=g.suspensionLength,H=y-M;x=g.suspensionStiffness*H*g.clippedInvContactDotSuspension;var W=g.suspensionRelativeVelocity,S;W<0?S=g.dampingCompression:S=g.dampingRelaxation,x-=S*W,g.suspensionForce=x*j,g.suspensionForce<0&&(g.suspensionForce=0)}else g.suspensionForce=0}},l.prototype.removeFromWorld=function(z){this.constraints,z.remove(this.chassisBody),z.removeEventListener("preStep",this.preStepCallback),this.world=null};var a=new u,s=new u;l.prototype.castRay=function(z){var C=a,j=s;this.updateWheelTransformWorld(z);var q=this.chassisBody,b=-1,T=z.suspensionRestLength+z.radius;z.directionWorld.scale(T,C);var g=z.chassisConnectionPointWorld;g.vadd(C,j);var x=z.raycastResult;x.reset();var y=q.collisionResponse;q.collisionResponse=!1,this.world.rayTest(g,j,x),q.collisionResponse=y;var M=x.body;if(z.raycastResult.groundObject=0,M){b=x.distance,z.raycastResult.hitNormalWorld=x.hitNormalWorld,z.isInContact=!0;var H=x.distance;z.suspensionLength=H-z.radius;var W=z.suspensionRestLength-z.maxSuspensionTravel,S=z.suspensionRestLength+z.maxSuspensionTravel;z.suspensionLength<W&&(z.suspensionLength=W),z.suspensionLength>S&&(z.suspensionLength=S,z.raycastResult.reset());var L=z.raycastResult.hitNormalWorld.dot(z.directionWorld),Z=new u;q.getVelocityAtWorldPoint(z.raycastResult.hitPointWorld,Z);var dt=z.raycastResult.hitNormalWorld.dot(Z);if(L>=-.1)z.suspensionRelativeVelocity=0,z.clippedInvContactDotSuspension=1/.1;else{var ct=-1/L;z.suspensionRelativeVelocity=dt*ct,z.clippedInvContactDotSuspension=ct}}else z.suspensionLength=z.suspensionRestLength+0*z.maxSuspensionTravel,z.suspensionRelativeVelocity=0,z.directionWorld.scale(-1,z.raycastResult.hitNormalWorld),z.clippedInvContactDotSuspension=1;return b},l.prototype.updateWheelTransformWorld=function(z){z.isInContact=!1;var C=this.chassisBody;C.pointToWorldFrame(z.chassisConnectionPointLocal,z.chassisConnectionPointWorld),C.vectorToWorldFrame(z.directionLocal,z.directionWorld),C.vectorToWorldFrame(z.axleLocal,z.axleWorld)},l.prototype.updateWheelTransform=function(z){var C=o,j=t,q=i,b=this.wheelInfos[z];this.updateWheelTransformWorld(b),b.directionLocal.scale(-1,C),j.copy(b.axleLocal),C.cross(j,q),q.normalize(),j.normalize();var T=b.steering,g=new e;g.setFromAxisAngle(C,T);var x=new e;x.setFromAxisAngle(j,b.rotation);var y=b.worldTransform.quaternion;this.chassisBody.quaternion.mult(g,y),y.mult(x,y),y.normalize();var M=b.worldTransform.position;M.copy(b.directionWorld),M.scale(b.suspensionLength,M),M.vadd(b.chassisConnectionPointWorld,M)};var h=[new u(1,0,0),new u(0,1,0),new u(0,0,1)];l.prototype.getWheelTransformWorld=function(z){return this.wheelInfos[z].worldTransform};var c=new u,p=[],f=[],w=1;l.prototype.updateFriction=function(z){for(var C=c,j=this.wheelInfos,q=j.length,b=this.chassisBody,T=f,g=p,x=0;x<q;x++){var y=j[x],M=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,T[x]||(T[x]=new u),g[x]||(g[x]=new u)}for(var x=0;x<q;x++){var y=j[x],M=y.raycastResult.body;if(M){var H=g[x],W=this.getWheelTransformWorld(x);W.vectorToWorldFrame(h[this.indexRightAxis],H);var S=y.raycastResult.hitNormalWorld,L=H.dot(S);S.scale(L,C),H.vsub(C,H),H.normalize(),S.cross(H,T[x]),T[x].normalize(),y.sideImpulse=vt(b,y.raycastResult.hitPointWorld,M,y.raycastResult.hitPointWorld,H),y.sideImpulse*=w}}var Z=1,dt=.5;this.sliding=!1;for(var x=0;x<q;x++){var y=j[x],M=y.raycastResult.body,ct=0;if(y.slipInfo=1,M){var at=0,k=y.brake?y.brake:at;ct=Y(b,M,y.raycastResult.hitPointWorld,T[x],k),ct+=y.engineForce*z;var Q=k/ct;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,M){y.skidInfo=1;var Ct=y.suspensionForce*z*y.frictionSlip,mt=Ct,Vt=Ct*mt;y.forwardImpulse=ct;var ht=y.forwardImpulse*dt,Rt=y.sideImpulse*Z,Nt=ht*ht+Rt*Rt;if(y.sliding=!1,Nt>Vt){this.sliding=!0,y.sliding=!0;var Q=Ct/Math.sqrt(Nt);y.skidInfo*=Q}}}if(this.sliding)for(var x=0;x<q;x++){var y=j[x];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var x=0;x<q;x++){var y=j[x],Pt=new u;if(Pt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Ft=new u;T[x].scale(y.forwardImpulse,Ft),b.applyImpulse(Ft,Pt)}if(y.sideImpulse!==0){var M=y.raycastResult.body,Mt=new u;Mt.copy(y.raycastResult.hitPointWorld);var It=new u;g[x].scale(y.sideImpulse,It),b.pointToLocalFrame(Pt,Pt),Pt["xyz"[this.indexUpAxis]]*=y.rollInfluence,b.pointToWorldFrame(Pt,Pt),b.applyImpulse(It,Pt),It.scale(-1,It),M.applyImpulse(It,Mt)}}};var m=new u,B=new u,U=new u;function Y(z,C,j,q,b){var T=0,g=j,x=m,y=B,M=U;z.getVelocityAtWorldPoint(g,x),C.getVelocityAtWorldPoint(g,y),x.vsub(y,M);var H=q.dot(M),W=F(z,j,q),S=F(C,j,q),L=1,Z=L/(W+S);return T=-H*Z,b<T&&(T=b),T<-b&&(T=-b),T}var V=new u,D=new u,R=new u,A=new u;function F(z,C,j){var q=V,b=D,T=R,g=A;return C.vsub(z.position,q),q.cross(j,b),z.invInertiaWorld.vmult(b,g),g.cross(q,T),z.invMass+j.dot(T)}var I=new u,$=new u,J=new u;function vt(z,C,j,q,b,L){var g=b.norm2();if(g>1.1)return 0;var x=I,y=$,M=J;z.getVelocityAtWorldPoint(C,x),j.getVelocityAtWorldPoint(q,y),x.vsub(y,M);var H=b.dot(M),W=.2,S=1/(z.invMass+j.invMass),L=-W*H*S;return L}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(d,v,_){var u=d("./Body"),e=d("../shapes/Sphere"),r=d("../shapes/Box"),n=d("../math/Vec3"),l=d("../constraints/HingeConstraint");v.exports=o;function o(a){if(this.wheelBodies=[],this.coordinateSystem=typeof a.coordinateSystem>"u"?new n(1,2,3):a.coordinateSystem.clone(),this.chassisBody=a.chassisBody,!this.chassisBody){var s=new r(new n(5,2,.5));this.chassisBody=new u(1,s)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}o.prototype.addWheel=function(a){a=a||{};var s=a.body;s||(s=new u(1,new e(1.2))),this.wheelBodies.push(s),this.wheelForces.push(0),new n;var h=typeof a.position<"u"?a.position.clone():new n,c=new n;this.chassisBody.pointToWorldFrame(h,c),s.position.set(c.x,c.y,c.z);var p=typeof a.axis<"u"?a.axis.clone():new n(0,1,0);this.wheelAxes.push(p);var f=new l(this.chassisBody,s,{pivotA:h,axisA:p,pivotB:n.ZERO,axisB:p,collideConnected:!1});return this.constraints.push(f),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(a,s){var h=this.wheelAxes[s],c=Math.cos(a),p=Math.sin(a),f=h.x,w=h.y;this.constraints[s].axisA.set(c*f-p*w,p*f+c*w,0)},o.prototype.setMotorSpeed=function(a,s){var h=this.constraints[s];h.enableMotor(),h.motorTargetVelocity=a},o.prototype.disableMotor=function(a){var s=this.constraints[a];s.disableMotor()};var t=new n;o.prototype.setWheelForce=function(a,s){this.wheelForces[s]=a},o.prototype.applyWheelForce=function(a,s){var h=this.wheelAxes[s],c=this.wheelBodies[s],p=c.torque;h.scale(a,t),c.vectorToWorldFrame(t,t),p.vadd(t,p)},o.prototype.addToWorld=function(a){for(var s=this.constraints,h=this.wheelBodies.concat([this.chassisBody]),c=0;c<h.length;c++)a.add(h[c]);for(var c=0;c<s.length;c++)a.addConstraint(s[c]);a.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var a=this.wheelForces,s=0;s<a.length;s++)this.applyWheelForce(a[s],s)},o.prototype.removeFromWorld=function(a){for(var s=this.constraints,h=this.wheelBodies.concat([this.chassisBody]),c=0;c<h.length;c++)a.remove(h[c]);for(var c=0;c<s.length;c++)a.removeConstraint(s[c])};var i=new n;o.prototype.getWheelSpeed=function(a){var s=this.wheelAxes[a],h=this.wheelBodies[a],c=h.angularVelocity;return this.chassisBody.vectorToWorldFrame(s,i),c.dot(i)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(d,v,_){v.exports=e,d("../shapes/Shape");var u=d("../math/Vec3");d("../math/Quaternion"),d("../shapes/Particle"),d("../objects/Body"),d("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(s){this.particles.push(s),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(s){var h=this.particles.indexOf(s);h!==-1&&(this.particles.splice(h,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new u;e.prototype.getNeighbors=function(s,h){for(var c=this.particles.length,p=s.id,f=this.smoothingRadius*this.smoothingRadius,w=r,m=0;m!==c;m++){var B=this.particles[m];B.position.vsub(s.position,w),p!==B.id&&w.norm2()<f&&h.push(B)}};var n=new u,l=new u,o=new u,t=new u,i=new u,a=new u;e.prototype.update=function(){for(var s=this.particles.length,h=n,c=this.speedOfSound,p=this.eps,f=0;f!==s;f++){var w=this.particles[f],m=this.neighbors[f];m.length=0,this.getNeighbors(w,m),m.push(this.particles[f]);for(var B=m.length,U=0,Y=0;Y!==B;Y++){w.position.vsub(m[Y].position,h);var V=h.norm(),D=this.w(V);U+=m[Y].mass*D}this.densities[f]=U,this.pressures[f]=c*c*(this.densities[f]-this.density)}for(var R=l,A=o,F=t,I=i,$=a,f=0;f!==s;f++){var J=this.particles[f];R.set(0,0,0),A.set(0,0,0);for(var vt,z,m=this.neighbors[f],B=m.length,Y=0;Y!==B;Y++){var C=m[Y];J.position.vsub(C.position,I);var j=I.norm();vt=-C.mass*(this.pressures[f]/(this.densities[f]*this.densities[f]+p)+this.pressures[Y]/(this.densities[Y]*this.densities[Y]+p)),this.gradw(I,F),F.mult(vt,F),R.vadd(F,R),C.velocity.vsub(J.velocity,$),$.mult(1/(1e-4+this.densities[f]*this.densities[Y])*this.viscosity*C.mass,$),z=this.nablaw(j),$.mult(z,$),A.vadd($,A)}A.mult(J.mass,A),R.mult(J.mass,R),J.force.vadd(A,J.force),J.force.vadd(R,J.force)}},e.prototype.w=function(s){var h=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(h,9))*Math.pow(h*h-s*s,3)},e.prototype.gradw=function(s,h){var c=s.norm(),p=this.smoothingRadius;s.mult(945/(32*Math.PI*Math.pow(p,9))*Math.pow(p*p-c*c,2),h)},e.prototype.nablaw=function(s){var h=this.smoothingRadius,c=945/(32*Math.PI*Math.pow(h,9))*(h*h-s*s)*(7*s*s-3*h*h);return c}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(d,v,_){var u=d("../math/Vec3");v.exports=e;function e(f,w,m){m=m||{},this.restLength=typeof m.restLength=="number"?m.restLength:1,this.stiffness=m.stiffness||100,this.damping=m.damping||1,this.bodyA=f,this.bodyB=w,this.localAnchorA=new u,this.localAnchorB=new u,m.localAnchorA&&this.localAnchorA.copy(m.localAnchorA),m.localAnchorB&&this.localAnchorB.copy(m.localAnchorB),m.worldAnchorA&&this.setWorldAnchorA(m.worldAnchorA),m.worldAnchorB&&this.setWorldAnchorB(m.worldAnchorB)}e.prototype.setWorldAnchorA=function(f){this.bodyA.pointToLocalFrame(f,this.localAnchorA)},e.prototype.setWorldAnchorB=function(f){this.bodyB.pointToLocalFrame(f,this.localAnchorB)},e.prototype.getWorldAnchorA=function(f){this.bodyA.pointToWorldFrame(this.localAnchorA,f)},e.prototype.getWorldAnchorB=function(f){this.bodyB.pointToWorldFrame(this.localAnchorB,f)};var r=new u,n=new u,l=new u,o=new u,t=new u,i=new u,a=new u,s=new u,h=new u,c=new u,p=new u;e.prototype.applyForce=function(){var f=this.stiffness,w=this.damping,m=this.restLength,B=this.bodyA,U=this.bodyB,Y=r,V=n,D=l,R=o,A=p,F=t,I=i,$=a,J=s,vt=h,z=c;this.getWorldAnchorA(F),this.getWorldAnchorB(I),F.vsub(B.position,$),I.vsub(U.position,J),I.vsub(F,Y);var C=Y.norm();V.copy(Y),V.normalize(),U.velocity.vsub(B.velocity,D),U.angularVelocity.cross(J,A),D.vadd(A,D),B.angularVelocity.cross($,A),D.vsub(A,D),V.mult(-f*(C-m)-w*D.dot(V),R),B.force.vsub(R,B.force),U.force.vadd(R,U.force),$.cross(R,vt),J.cross(R,z),B.torque.vsub(vt,B.torque),U.torque.vadd(z,U.torque)}},{"../math/Vec3":30}],36:[function(d,v,_){var u=d("../math/Vec3"),e=d("../math/Transform"),r=d("../collision/RaycastResult"),n=d("../utils/Utils");v.exports=l;function l(i){i=n.defaults(i,{chassisConnectionPointLocal:new u,chassisConnectionPointWorld:new u,directionLocal:new u,directionWorld:new u,axleLocal:new u,axleWorld:new u,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=i.maxSuspensionTravel,this.customSlidingRotationalSpeed=i.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=i.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=i.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=i.chassisConnectionPointWorld.clone(),this.directionLocal=i.directionLocal.clone(),this.directionWorld=i.directionWorld.clone(),this.axleLocal=i.axleLocal.clone(),this.axleWorld=i.axleWorld.clone(),this.suspensionRestLength=i.suspensionRestLength,this.suspensionMaxLength=i.suspensionMaxLength,this.radius=i.radius,this.suspensionStiffness=i.suspensionStiffness,this.dampingCompression=i.dampingCompression,this.dampingRelaxation=i.dampingRelaxation,this.frictionSlip=i.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=i.rollInfluence,this.maxSuspensionForce=i.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=i.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new e,this.isInContact=!1}var t=new u,o=new u,t=new u;l.prototype.updateWheel=function(i){var a=this.raycastResult;if(this.isInContact){var s=a.hitNormalWorld.dot(a.directionWorld);a.hitPointWorld.vsub(i.position,o),i.getVelocityAtWorldPoint(o,t);var h=a.hitNormalWorld.dot(t);if(s>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var c=-1/s;this.suspensionRelativeVelocity=h*c,this.clippedInvContactDotSuspension=c}}else a.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,a.directionWorld.scale(-1,a.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(d,v,_){v.exports=n;var u=d("./Shape"),e=d("../math/Vec3"),r=d("./ConvexPolyhedron");function n(t){u.call(this),this.type=u.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}n.prototype=new u,n.prototype.constructor=n,n.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,a=this.halfExtents.z,s=e,h=[new s(-t,-i,-a),new s(t,-i,-a),new s(t,i,-a),new s(-t,i,-a),new s(-t,-i,a),new s(t,-i,a),new s(t,i,a),new s(-t,i,a)],c=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new s(0,0,1),new s(0,1,0),new s(1,0,0);var p=new r(h,c);this.convexPolyhedronRepresentation=p,p.material=this.material},n.prototype.calculateLocalInertia=function(t,i){return i=i||new e,n.calculateInertia(this.halfExtents,t,i),i},n.calculateInertia=function(t,i,a){var s=t;a.x=1/12*i*(2*s.y*2*s.y+2*s.z*2*s.z),a.y=1/12*i*(2*s.x*2*s.x+2*s.z*2*s.z),a.z=1/12*i*(2*s.y*2*s.y+2*s.x*2*s.x)},n.prototype.getSideNormals=function(t,i){var a=t,s=this.halfExtents;if(a[0].set(s.x,0,0),a[1].set(0,s.y,0),a[2].set(0,0,s.z),a[3].set(-s.x,0,0),a[4].set(0,-s.y,0),a[5].set(0,0,-s.z),i!==void 0)for(var h=0;h!==a.length;h++)i.vmult(a[h],a[h]);return a},n.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,n.prototype.forEachWorldCorner=function(t,i,a){for(var s=this.halfExtents,h=[[s.x,s.y,s.z],[-s.x,s.y,s.z],[-s.x,-s.y,s.z],[-s.x,-s.y,-s.z],[s.x,-s.y,-s.z],[s.x,s.y,-s.z],[-s.x,s.y,-s.z],[s.x,-s.y,s.z]],c=0;c<h.length;c++)l.set(h[c][0],h[c][1],h[c][2]),i.vmult(l,l),t.vadd(l,l),a(l.x,l.y,l.z)};var o=[new e,new e,new e,new e,new e,new e,new e,new e];n.prototype.calculateWorldAABB=function(t,i,a,s){var h=this.halfExtents;o[0].set(h.x,h.y,h.z),o[1].set(-h.x,h.y,h.z),o[2].set(-h.x,-h.y,h.z),o[3].set(-h.x,-h.y,-h.z),o[4].set(h.x,-h.y,-h.z),o[5].set(h.x,h.y,-h.z),o[6].set(-h.x,h.y,-h.z),o[7].set(h.x,-h.y,h.z);var c=o[0];i.vmult(c,c),t.vadd(c,c),s.copy(c),a.copy(c);for(var p=1;p<8;p++){var c=o[p];i.vmult(c,c),t.vadd(c,c);var f=c.x,w=c.y,m=c.z;f>s.x&&(s.x=f),w>s.y&&(s.y=w),m>s.z&&(s.z=m),f<a.x&&(a.x=f),w<a.y&&(a.y=w),m<a.z&&(a.z=m)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(d,v,_){v.exports=n;var u=d("./Shape"),e=d("../math/Vec3");d("../math/Quaternion");var r=d("../math/Transform");function n(b,T,g){u.call(this),this.type=u.types.CONVEXPOLYHEDRON,this.vertices=b||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=T||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=g?g.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}n.prototype=new u,n.prototype.constructor=n;var l=new e;n.prototype.computeEdges=function(){var b=this.faces,T=this.vertices;T.length;var g=this.uniqueEdges;g.length=0;for(var x=l,y=0;y!==b.length;y++)for(var M=b[y],H=M.length,W=0;W!==H;W++){var S=(W+1)%H;T[M[W]].vsub(T[M[S]],x),x.normalize();for(var L=!1,Z=0;Z!==g.length;Z++)if(g[Z].almostEquals(x)||g[Z].almostEquals(x)){L=!0;break}L||g.push(x.clone())}},n.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var b=0;b<this.faces.length;b++){for(var T=0;T<this.faces[b].length;T++)if(!this.vertices[this.faces[b][T]])throw new Error("Vertex "+this.faces[b][T]+" not found!");var g=this.faceNormals[b]||new e;this.getFaceNormal(b,g),g.negate(g),this.faceNormals[b]=g;var x=this.vertices[this.faces[b][0]];if(g.dot(x)<0){console.error(".faceNormals["+b+"] = Vec3("+g.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var T=0;T<this.faces[b].length;T++)console.warn(".vertices["+this.faces[b][T]+"] = Vec3("+this.vertices[this.faces[b][T]].toString()+")")}}};var o=new e,t=new e;n.computeNormal=function(b,T,g,x){T.vsub(b,t),g.vsub(T,o),o.cross(t,x),x.isZero()||x.normalize()},n.prototype.getFaceNormal=function(b,T){var g=this.faces[b],x=this.vertices[g[0]],y=this.vertices[g[1]],M=this.vertices[g[2]];return n.computeNormal(x,y,M,T)};var i=new e;n.prototype.clipAgainstHull=function(b,T,g,x,y,M,H,W,S){for(var L=i,Z=-1,dt=-Number.MAX_VALUE,ct=0;ct<g.faces.length;ct++){L.copy(g.faceNormals[ct]),y.vmult(L,L);var at=L.dot(M);at>dt&&(dt=at,Z=ct)}for(var k=[],Q=g.faces[Z],Ct=Q.length,mt=0;mt<Ct;mt++){var Vt=g.vertices[Q[mt]],ht=new e;ht.copy(Vt),y.vmult(ht,ht),x.vadd(ht,ht),k.push(ht)}Z>=0&&this.clipFaceAgainstHull(M,b,T,k,H,W,S)};var a=new e,s=new e,h=new e,c=new e,p=new e,f=new e;n.prototype.findSeparatingAxis=function(b,T,g,x,y,M,H,W){var S=a,L=s,Z=h,dt=c,ct=p,at=f,k=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var mt=0;mt!==Q.uniqueAxes.length;mt++){g.vmult(Q.uniqueAxes[mt],S);var ht=Q.testSepAxis(S,b,T,g,x,y);if(ht===!1)return!1;ht<k&&(k=ht,M.copy(S))}else for(var Ct=H?H.length:Q.faces.length,mt=0;mt<Ct;mt++){var Vt=H?H[mt]:mt;S.copy(Q.faceNormals[Vt]),g.vmult(S,S);var ht=Q.testSepAxis(S,b,T,g,x,y);if(ht===!1)return!1;ht<k&&(k=ht,M.copy(S))}if(b.uniqueAxes)for(var mt=0;mt!==b.uniqueAxes.length;mt++){y.vmult(b.uniqueAxes[mt],L);var ht=Q.testSepAxis(L,b,T,g,x,y);if(ht===!1)return!1;ht<k&&(k=ht,M.copy(L))}else for(var Rt=W?W.length:b.faces.length,mt=0;mt<Rt;mt++){var Vt=W?W[mt]:mt;L.copy(b.faceNormals[Vt]),y.vmult(L,L);var ht=Q.testSepAxis(L,b,T,g,x,y);if(ht===!1)return!1;ht<k&&(k=ht,M.copy(L))}for(var Nt=0;Nt!==Q.uniqueEdges.length;Nt++){g.vmult(Q.uniqueEdges[Nt],dt);for(var Pt=0;Pt!==b.uniqueEdges.length;Pt++)if(y.vmult(b.uniqueEdges[Pt],ct),dt.cross(ct,at),!at.almostZero()){at.normalize();var Ft=Q.testSepAxis(at,b,T,g,x,y);if(Ft===!1)return!1;Ft<k&&(k=Ft,M.copy(at))}}return x.vsub(T,Z),Z.dot(M)>0&&M.negate(M),!0};var w=[],m=[];n.prototype.testSepAxis=function(b,T,g,x,y,M){var H=this;n.project(H,b,g,x,w),n.project(T,b,y,M,m);var W=w[0],S=w[1],L=m[0],Z=m[1],dt=W-Z,ct=L-S,at=dt<ct?dt:ct;return at};var B=new e,U=new e;n.prototype.calculateLocalInertia=function(b,T){this.computeLocalAABB(B,U);var g=U.x-B.x,x=U.y-B.y,y=U.z-B.z;T.x=1/12*b*(2*x*2*x+2*y*2*y),T.y=1/12*b*(2*g*2*g+2*y*2*y),T.z=1/12*b*(2*x*2*x+2*g*2*g)},n.prototype.getPlaneConstantOfFace=function(b){var T=this.faces[b],g=this.faceNormals[b],x=this.vertices[T[0]],y=-g.dot(x);return y};var Y=new e,V=new e,D=new e,R=new e,A=new e,F=new e,I=new e,$=new e;n.prototype.clipFaceAgainstHull=function(b,T,g,x,y,M,H){for(var W=Y,S=V,L=D,Z=R,dt=A,ct=F,at=I,k=$,Q=this,Ct=[],mt=x,Vt=Ct,ht=-1,Rt=Number.MAX_VALUE,Nt=0;Nt<Q.faces.length;Nt++){W.copy(Q.faceNormals[Nt]),g.vmult(W,W);var Pt=W.dot(b);Pt<Rt&&(Rt=Pt,ht=Nt)}if(!(ht<0)){var Ft=Q.faces[ht];Ft.connectedFaces=[];for(var Mt=0;Mt<Q.faces.length;Mt++)for(var It=0;It<Q.faces[Mt].length;It++)Ft.indexOf(Q.faces[Mt][It])!==-1&&Mt!==ht&&Ft.connectedFaces.indexOf(Mt)===-1&&Ft.connectedFaces.push(Mt);mt.length;for(var St=Ft.length,Ut=0;Ut<St;Ut++){var Qt=Q.vertices[Ft[Ut]],le=Q.vertices[Ft[(Ut+1)%St]];Qt.vsub(le,S),L.copy(S),g.vmult(L,L),T.vadd(L,L),Z.copy(this.faceNormals[ht]),g.vmult(Z,Z),T.vadd(Z,Z),L.cross(Z,dt),dt.negate(dt),ct.copy(Qt),g.vmult(ct,ct),T.vadd(ct,ct),-ct.dot(dt);var pt;{var ce=Ft.connectedFaces[Ut];at.copy(this.faceNormals[ce]);var E=this.getPlaneConstantOfFace(ce);k.copy(at),g.vmult(k,k);var pt=E-k.dot(T)}for(this.clipFaceAgainstPlane(mt,Vt,k,pt);mt.length;)mt.shift();for(;Vt.length;)mt.push(Vt.shift())}at.copy(this.faceNormals[ht]);var E=this.getPlaneConstantOfFace(ht);k.copy(at),g.vmult(k,k);for(var pt=E-k.dot(T),Mt=0;Mt<mt.length;Mt++){var zt=k.dot(mt[Mt])+pt;if(zt<=y&&(console.log("clamped: depth="+zt+" to minDist="+(y+"")),zt=y),zt<=M){var Wt=mt[Mt];if(zt<=0){var Dt={point:Wt,normal:k,depth:zt};H.push(Dt)}}}}},n.prototype.clipFaceAgainstPlane=function(b,T,g,x){var y,M,H=b.length;if(H<2)return T;var W=b[b.length-1],S=b[0];y=g.dot(W)+x;for(var L=0;L<H;L++){if(S=b[L],M=g.dot(S)+x,y<0)if(M<0){var Z=new e;Z.copy(S),T.push(Z)}else{var Z=new e;W.lerp(S,y/(y-M),Z),T.push(Z)}else if(M<0){var Z=new e;W.lerp(S,y/(y-M),Z),T.push(Z),T.push(S)}W=S,y=M}return T},n.prototype.computeWorldVertices=function(b,T){for(var g=this.vertices.length;this.worldVertices.length<g;)this.worldVertices.push(new e);for(var x=this.vertices,y=this.worldVertices,M=0;M!==g;M++)T.vmult(x[M],y[M]),b.vadd(y[M],y[M]);this.worldVerticesNeedsUpdate=!1},new e,n.prototype.computeLocalAABB=function(b,T){var g=this.vertices.length,x=this.vertices;b.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),T.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<g;y++){var M=x[y];M.x<b.x?b.x=M.x:M.x>T.x&&(T.x=M.x),M.y<b.y?b.y=M.y:M.y>T.y&&(T.y=M.y),M.z<b.z?b.z=M.z:M.z>T.z&&(T.z=M.z)}},n.prototype.computeWorldFaceNormals=function(b){for(var T=this.faceNormals.length;this.worldFaceNormals.length<T;)this.worldFaceNormals.push(new e);for(var g=this.faceNormals,x=this.worldFaceNormals,y=0;y!==T;y++)b.vmult(g[y],x[y]);this.worldFaceNormalsNeedsUpdate=!1},n.prototype.updateBoundingSphereRadius=function(){for(var b=0,T=this.vertices,g=0,x=T.length;g!==x;g++){var y=T[g].norm2();y>b&&(b=y)}this.boundingSphereRadius=Math.sqrt(b)};var J=new e;n.prototype.calculateWorldAABB=function(b,T,g,x){for(var y=this.vertices.length,M=this.vertices,H,W,S,L,Z,dt,ct=0;ct<y;ct++){J.copy(M[ct]),T.vmult(J,J),b.vadd(J,J);var at=J;at.x<H||H===void 0?H=at.x:(at.x>L||L===void 0)&&(L=at.x),at.y<W||W===void 0?W=at.y:(at.y>Z||Z===void 0)&&(Z=at.y),at.z<S||S===void 0?S=at.z:(at.z>dt||dt===void 0)&&(dt=at.z)}g.set(H,W,S),x.set(L,Z,dt)},n.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},n.prototype.getAveragePointLocal=function(b){b=b||new e;for(var T=this.vertices.length,g=this.vertices,x=0;x<T;x++)b.vadd(g[x],b);return b.mult(1/T,b),b},n.prototype.transformAllPoints=function(b,T){var g=this.vertices.length,x=this.vertices;if(T){for(var y=0;y<g;y++){var M=x[y];T.vmult(M,M)}for(var y=0;y<this.faceNormals.length;y++){var M=this.faceNormals[y];T.vmult(M,M)}}if(b)for(var y=0;y<g;y++){var M=x[y];M.vadd(b,M)}};var vt=new e,z=new e,C=new e;n.prototype.pointIsInside=function(b){var T=this.vertices.length,g=this.vertices,x=this.faces,y=this.faceNormals,M=null,H=this.faces.length,W=vt;this.getAveragePointLocal(W);for(var S=0;S<H;S++){this.faces[S].length;var T=y[S],L=g[x[S][0]],Z=z;b.vsub(L,Z);var dt=T.dot(Z),ct=C;W.vsub(L,ct);var at=T.dot(ct);if(dt<0&&at>0||dt>0&&at<0)return!1}return M?1:-1},new e;var j=new e,q=new e;n.project=function(b,T,g,x,y){var M=b.vertices.length,H=j,W=0,S=0,L=q,Z=b.vertices;L.setZero(),r.vectorToLocalFrame(g,x,T,H),r.pointToLocalFrame(g,x,L,L);var dt=L.dot(H);S=W=Z[0].dot(H);for(var ct=1;ct<M;ct++){var at=Z[ct].dot(H);at>W&&(W=at),at<S&&(S=at)}if(S-=dt,W-=dt,S>W){var k=S;S=W,W=k}y[0]=W,y[1]=S}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(d,v,_){v.exports=n;var u=d("./Shape"),e=d("../math/Vec3");d("../math/Quaternion");var r=d("./ConvexPolyhedron");function n(l,o,t,i){var a=i,s=[],h=[],c=[],p=[],f=[],w=Math.cos,m=Math.sin;s.push(new e(o*w(0),o*m(0),-t*.5)),p.push(0),s.push(new e(l*w(0),l*m(0),t*.5)),f.push(1);for(var B=0;B<a;B++){var U=2*Math.PI/a*(B+1),Y=2*Math.PI/a*(B+.5);B<a-1?(s.push(new e(o*w(U),o*m(U),-t*.5)),p.push(2*B+2),s.push(new e(l*w(U),l*m(U),t*.5)),f.push(2*B+3),c.push([2*B+2,2*B+3,2*B+1,2*B])):c.push([0,1,2*B+1,2*B]),(a%2===1||B<a/2)&&h.push(new e(w(Y),m(Y),0))}c.push(f),h.push(new e(0,0,1));for(var V=[],B=0;B<p.length;B++)V.push(p[p.length-B-1]);c.push(V),this.type=u.types.CONVEXPOLYHEDRON,r.call(this,s,c,h)}n.prototype=new r},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(d,v,_){var u=d("./Shape"),e=d("./ConvexPolyhedron"),r=d("../math/Vec3"),n=d("../utils/Utils");v.exports=l;function l(o,t){t=n.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=o,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,u.call(this),this.pillarConvex=new e,this.pillarOffset=new r,this.type=u.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new u,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var a=0;a!==o[i].length;a++){var s=o[i][a];s<t&&(t=s)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var a=0;a!==o[i].length;a++){var s=o[i][a];s>t&&(t=s)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(o,t,i){var a=this.data;a[o][t]=i,this.clearCachedConvexTrianglePillar(o,t,!1),o>0&&(this.clearCachedConvexTrianglePillar(o-1,t,!0),this.clearCachedConvexTrianglePillar(o-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(o,t-1,!0),this.clearCachedConvexTrianglePillar(o,t-1,!1)),t>0&&o>0&&this.clearCachedConvexTrianglePillar(o-1,t-1,!0)},l.prototype.getRectMinMax=function(o,t,i,a,s){s=s||[];for(var h=this.data,c=this.minValue,p=o;p<=i;p++)for(var f=t;f<=a;f++){var w=h[p][f];w>c&&(c=w)}s[0]=this.minValue,s[1]=c},l.prototype.getIndexOfPosition=function(o,t,i,a){var s=this.elementSize,h=this.data,c=Math.floor(o/s),p=Math.floor(t/s);return i[0]=c,i[1]=p,a&&(c<0&&(c=0),p<0&&(p=0),c>=h.length-1&&(c=h.length-1),p>=h[0].length-1&&(p=h[0].length-1)),!(c<0||p<0||c>=h.length-1||p>=h[0].length-1)},l.prototype.getHeightAt=function(o,t,i){var a=[];this.getIndexOfPosition(o,t,a,i);var s=[];return this.getRectMinMax(a[0],a[1]+1,a[0],a[1]+1,s),(s[0]+s[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(o,t,i){return o+"_"+t+"_"+(i?1:0)},l.prototype.getCachedConvexTrianglePillar=function(o,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.setCachedConvexTrianglePillar=function(o,t,i,a,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]={convex:a,offset:s}},l.prototype.clearCachedConvexTrianglePillar=function(o,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.getConvexTrianglePillar=function(o,t,i){var a=this.pillarConvex,s=this.pillarOffset;if(this.cacheEnabled){var h=this.getCachedConvexTrianglePillar(o,t,i);if(h){this.pillarConvex=h.convex,this.pillarOffset=h.offset;return}a=new e,s=new r,this.pillarConvex=a,this.pillarOffset=s}var h=this.data,c=this.elementSize,p=a.faces;a.vertices.length=6;for(var f=0;f<6;f++)a.vertices[f]||(a.vertices[f]=new r);p.length=5;for(var f=0;f<5;f++)p[f]||(p[f]=[]);var w=a.vertices,m=(Math.min(h[o][t],h[o+1][t],h[o][t+1],h[o+1][t+1])-this.minValue)/2+this.minValue;i?(s.set((o+.75)*c,(t+.75)*c,m),w[0].set(.25*c,.25*c,h[o+1][t+1]-m),w[1].set(-.75*c,.25*c,h[o][t+1]-m),w[2].set(.25*c,-.75*c,h[o+1][t]-m),w[3].set(.25*c,.25*c,-m-1),w[4].set(-.75*c,.25*c,-m-1),w[5].set(.25*c,-.75*c,-m-1),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=2,p[2][1]=5,p[2][2]=3,p[2][3]=0,p[3][0]=3,p[3][1]=4,p[3][2]=1,p[3][3]=0,p[4][0]=1,p[4][1]=4,p[4][2]=5,p[4][3]=2):(s.set((o+.25)*c,(t+.25)*c,m),w[0].set(-.25*c,-.25*c,h[o][t]-m),w[1].set(.75*c,-.25*c,h[o+1][t]-m),w[2].set(-.25*c,.75*c,h[o][t+1]-m),w[3].set(-.25*c,-.25*c,-m-1),w[4].set(.75*c,-.25*c,-m-1),w[5].set(-.25*c,.75*c,-m-1),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=0,p[2][1]=2,p[2][2]=5,p[2][3]=3,p[3][0]=1,p[3][1]=0,p[3][2]=3,p[3][3]=4,p[4][0]=4,p[4][1]=5,p[4][2]=2,p[4][3]=1),a.computeNormals(),a.computeEdges(),a.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(o,t,i,a,s)},l.prototype.calculateLocalInertia=function(o,t){return t=t||new r,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(o,t,i,a){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),a.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var o=this.data,t=this.elementSize;this.boundingSphereRadius=new r(o.length*t,o[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(d,v,_){v.exports=r;var u=d("./Shape"),e=d("../math/Vec3");function r(){u.call(this),this.type=u.types.PARTICLE}r.prototype=new u,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(n,l){return l=l||new e,l.set(0,0,0),l},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(n,l,o,t){o.copy(n),t.copy(n)}},{"../math/Vec3":30,"./Shape":43}],42:[function(d,v,_){v.exports=r;var u=d("./Shape"),e=d("../math/Vec3");function r(){u.call(this),this.type=u.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new u,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(l){var o=this.worldNormal;o.set(0,0,1),l.vmult(o,o),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(l,o){return o=o||new e,o},r.prototype.volume=function(){return Number.MAX_VALUE};var n=new e;r.prototype.calculateWorldAABB=function(l,o,t,i){n.set(0,0,1),o.vmult(n,n);var a=Number.MAX_VALUE;t.set(-a,-a,-a),i.set(a,a,a),n.x===1&&(i.x=l.x),n.y===1&&(i.y=l.y),n.z===1&&(i.z=l.z),n.x===-1&&(t.x=l.x),n.y===-1&&(t.y=l.y),n.z===-1&&(t.z=l.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(d,v,_){v.exports=u;var u=d("./Shape");d("../math/Vec3"),d("../math/Quaternion"),d("../material/Material");function u(){this.id=u.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}u.prototype.constructor=u,u.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},u.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},u.prototype.calculateLocalInertia=function(e,r){throw"calculateLocalInertia() not implemented for shape type "+this.type},u.idCounter=0,u.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(d,v,_){v.exports=r;var u=d("./Shape"),e=d("../math/Vec3");function r(n){if(u.call(this),this.radius=n!==void 0?Number(n):1,this.type=u.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new u,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(n,l){l=l||new e;var o=2*n*this.radius*this.radius/5;return l.x=o,l.y=o,l.z=o,l},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(n,l,o,t){for(var i=this.radius,a=["x","y","z"],s=0;s<a.length;s++){var h=a[s];o[h]=n[h]-i,t[h]=n[h]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(d,v,_){v.exports=o;var u=d("./Shape"),e=d("../math/Vec3");d("../math/Quaternion");var r=d("../math/Transform"),n=d("../collision/AABB"),l=d("../utils/Octree");function o(V,D){u.call(this),this.type=u.types.TRIMESH,this.vertices=new Float32Array(V),this.indices=new Int16Array(D),this.normals=new Float32Array(D.length),this.aabb=new n,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}o.prototype=new u,o.prototype.constructor=o;var t=new e;o.prototype.updateTree=function(){var V=this.tree;V.reset(),V.aabb.copy(this.aabb);var D=this.scale;V.aabb.lowerBound.x*=1/D.x,V.aabb.lowerBound.y*=1/D.y,V.aabb.lowerBound.z*=1/D.z,V.aabb.upperBound.x*=1/D.x,V.aabb.upperBound.y*=1/D.y,V.aabb.upperBound.z*=1/D.z;for(var R=new n,A=new e,F=new e,I=new e,$=[A,F,I],J=0;J<this.indices.length/3;J++){var vt=J*3;this._getUnscaledVertex(this.indices[vt],A),this._getUnscaledVertex(this.indices[vt+1],F),this._getUnscaledVertex(this.indices[vt+2],I),R.setFromPoints($),V.insert(R,J)}V.removeEmptyNodes()};var i=new n;o.prototype.getTrianglesInAABB=function(V,D){i.copy(V);var R=this.scale,A=R.x,F=R.y,I=R.z,$=i.lowerBound,J=i.upperBound;return $.x/=A,$.y/=F,$.z/=I,J.x/=A,J.y/=F,J.z/=I,this.tree.aabbQuery(i,D)},o.prototype.setScale=function(V){var D=this.scale.x===this.scale.y===this.scale.z,R=V.x===V.y===V.z;D&&R||this.updateNormals(),this.scale.copy(V),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var V=t,D=this.normals,R=0;R<this.indices.length/3;R++){var A=R*3,F=this.indices[A],I=this.indices[A+1],$=this.indices[A+2];this.getVertex(F,p),this.getVertex(I,f),this.getVertex($,w),o.computeNormal(f,p,w,V),D[A]=V.x,D[A+1]=V.y,D[A+2]=V.z}},o.prototype.updateEdges=function(){for(var V={},D=function(vt,z){var C=F<I?F+"_"+I:I+"_"+F;V[C]=!0},R=0;R<this.indices.length/3;R++){var A=R*3,F=this.indices[A],I=this.indices[A+1];this.indices[A+2],D(),D(),D()}var $=Object.keys(V);this.edges=new Int16Array($.length*2);for(var R=0;R<$.length;R++){var J=$[R].split("_");this.edges[2*R]=parseInt(J[0],10),this.edges[2*R+1]=parseInt(J[1],10)}},o.prototype.getEdgeVertex=function(V,D,R){var A=this.edges[V*2+(D?1:0)];this.getVertex(A,R)};var a=new e,s=new e;o.prototype.getEdgeVector=function(V,D){var R=a,A=s;this.getEdgeVertex(V,0,R),this.getEdgeVertex(V,1,A),A.vsub(R,D)};var h=new e,c=new e;o.computeNormal=function(V,D,R,A){D.vsub(V,c),R.vsub(D,h),h.cross(c,A),A.isZero()||A.normalize()};var p=new e,f=new e,w=new e;o.prototype.getVertex=function(V,D){var R=this.scale;return this._getUnscaledVertex(V,D),D.x*=R.x,D.y*=R.y,D.z*=R.z,D},o.prototype._getUnscaledVertex=function(V,D){var R=V*3,A=this.vertices;return D.set(A[R],A[R+1],A[R+2])},o.prototype.getWorldVertex=function(V,D,R,A){return this.getVertex(V,A),r.pointToWorldFrame(D,R,A,A),A},o.prototype.getTriangleVertices=function(V,D,R,A){var F=V*3;this.getVertex(this.indices[F],D),this.getVertex(this.indices[F+1],R),this.getVertex(this.indices[F+2],A)},o.prototype.getNormal=function(V,D){var R=V*3;return D.set(this.normals[R],this.normals[R+1],this.normals[R+2])};var m=new n;o.prototype.calculateLocalInertia=function(V,D){this.computeLocalAABB(m);var R=m.upperBound.x-m.lowerBound.x,A=m.upperBound.y-m.lowerBound.y,F=m.upperBound.z-m.lowerBound.z;return D.set(1/12*V*(2*A*2*A+2*F*2*F),1/12*V*(2*R*2*R+2*F*2*F),1/12*V*(2*A*2*A+2*R*2*R))};var B=new e;o.prototype.computeLocalAABB=function(V){var D=V.lowerBound,R=V.upperBound,A=this.vertices.length;this.vertices;var F=B;this.getVertex(0,F),D.copy(F),R.copy(F);for(var I=0;I!==A;I++)this.getVertex(I,F),F.x<D.x?D.x=F.x:F.x>R.x&&(R.x=F.x),F.y<D.y?D.y=F.y:F.y>R.y&&(R.y=F.y),F.z<D.z?D.z=F.z:F.z>R.z&&(R.z=F.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var V=0,D=this.vertices,R=new e,A=0,F=D.length/3;A!==F;A++){this.getVertex(A,R);var I=R.norm2();I>V&&(V=I)}this.boundingSphereRadius=Math.sqrt(V)},new e;var U=new r,Y=new n;o.prototype.calculateWorldAABB=function(V,D,R,A){var F=U,I=Y;F.position=V,F.quaternion=D,this.aabb.toWorldFrame(F,I),R.copy(I.lowerBound),A.copy(I.upperBound)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.createTorus=function(V,D,R,A,F){V=V||1,D=D||.5,R=R||8,A=A||6,F=F||Math.PI*2;for(var I=[],$=[],J=0;J<=R;J++)for(var vt=0;vt<=A;vt++){var z=vt/A*F,C=J/R*Math.PI*2,j=(V+D*Math.cos(C))*Math.cos(z),q=(V+D*Math.cos(C))*Math.sin(z),b=D*Math.sin(C);I.push(j,q,b)}for(var J=1;J<=R;J++)for(var vt=1;vt<=A;vt++){var T=(A+1)*J+vt-1,g=(A+1)*(J-1)+vt-1,x=(A+1)*(J-1)+vt,y=(A+1)*J+vt;$.push(T,g,y),$.push(g,x,y)}return new o(I,$)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(d,v,_){v.exports=e,d("../math/Vec3"),d("../math/Quaternion");var u=d("./Solver");function e(){u.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new u;var r=[],n=[],l=[];e.prototype.solve=function(o,t){var i=0,a=this.iterations,s=this.tolerance*this.tolerance,h=this.equations,c=h.length,p=t.bodies,f=p.length,w=o,m,B,U,Y,V,D;if(c!==0)for(var R=0;R!==f;R++)p[R].updateSolveMassProperties();var A=n,F=l,I=r;A.length=c,F.length=c,I.length=c;for(var R=0;R!==c;R++){var $=h[R];I[R]=0,F[R]=$.computeB(w),A[R]=1/$.computeC()}if(c!==0){for(var R=0;R!==f;R++){var J=p[R],vt=J.vlambda,z=J.wlambda;vt.set(0,0,0),z&&z.set(0,0,0)}for(i=0;i!==a;i++){Y=0;for(var C=0;C!==c;C++){var $=h[C];m=F[C],B=A[C],D=I[C],V=$.computeGWlambda(),U=B*(m-V-$.eps*D),D+U<$.minForce?U=$.minForce-D:D+U>$.maxForce&&(U=$.maxForce-D),I[C]+=U,Y+=U>0?U:-U,$.addToWlambda(U)}if(Y*Y<s)break}for(var R=0;R!==f;R++){var J=p[R],j=J.velocity,q=J.angularVelocity;j.vadd(J.vlambda,j),q&&q.vadd(J.wlambda,q)}}return i}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(d,v,_){v.exports=u;function u(){this.equations=[]}u.prototype.solve=function(e,r){return 0},u.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},u.prototype.removeEquation=function(e){var r=this.equations,n=r.indexOf(e);n!==-1&&r.splice(n,1)},u.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(d,v,_){v.exports=r,d("../math/Vec3"),d("../math/Quaternion");var u=d("./Solver"),e=d("../objects/Body");function r(p){for(u.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=p,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new u;var n=[],l=[],o={bodies:[]},t=e.STATIC;function i(p){for(var f=p.length,w=0;w!==f;w++){var m=p[w];if(!m.visited&&!(m.body.type&t))return m}return!1}var a=[];function s(p,f,w,m){for(a.push(p),p.visited=!0,f(p,w,m);a.length;)for(var B=a.pop(),U;U=i(B.children);)U.visited=!0,f(U,w,m),a.push(U)}function h(p,f,w){f.push(p.body);for(var m=p.eqs.length,B=0;B!==m;B++){var U=p.eqs[B];w.indexOf(U)===-1&&w.push(U)}}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(p,f){for(var w=n,m=this.nodePool,B=f.bodies,U=this.equations,Y=U.length,V=B.length,D=this.subsolver;m.length<V;)m.push(this.createNode());w.length=V;for(var R=0;R<V;R++)w[R]=m[R];for(var R=0;R!==V;R++){var A=w[R];A.body=B[R],A.children.length=0,A.eqs.length=0,A.visited=!1}for(var F=0;F!==Y;F++){var I=U[F],R=B.indexOf(I.bi),$=B.indexOf(I.bj),J=w[R],vt=w[$];J.children.push(vt),J.eqs.push(I),vt.children.push(J),vt.eqs.push(I)}var z,C=0,j=l;D.tolerance=this.tolerance,D.iterations=this.iterations;for(var q=o;z=i(w);){j.length=0,q.bodies.length=0,s(z,h,q.bodies,j);var b=j.length;j=j.sort(c);for(var R=0;R!==b;R++)D.addEquation(j[R]);D.solve(p,q),D.removeAllEquations(),C++}return C};function c(p,f){return f.id-p.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(d,v,_){var u=function(){};v.exports=u,u.prototype={constructor:u,addEventListener:function(e,r){this._listeners===void 0&&(this._listeners={});var n=this._listeners;return n[e]===void 0&&(n[e]=[]),n[e].indexOf(r)===-1&&n[e].push(r),this},hasEventListener:function(e,r){if(this._listeners===void 0)return!1;var n=this._listeners;return n[e]!==void 0&&n[e].indexOf(r)!==-1},removeEventListener:function(e,r){if(this._listeners===void 0)return this;var n=this._listeners;if(n[e]===void 0)return this;var l=n[e].indexOf(r);return l!==-1&&n[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var r=this._listeners,n=r[e.type];if(n!==void 0){e.target=this;for(var l=0,o=n.length;l<o;l++)n[l].call(this,e)}return this}}},{}],50:[function(d,v,_){var u=d("../collision/AABB"),e=d("../math/Vec3");v.exports=n;function r(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new u,this.data=[],this.children=[]}function n(t,i){i=i||{},i.root=null,i.aabb=t,r.call(this,i),this.maxDepth=typeof i.maxDepth<"u"?i.maxDepth:8}n.prototype=new r,r.prototype.reset=function(t,i){this.children.length=this.data.length=0},r.prototype.insert=function(t,i,a){var s=this.data;if(a=a||0,!this.aabb.contains(t))return!1;var h=this.children;if(a<(this.maxDepth||this.root.maxDepth)){var c=!1;h.length||(this.subdivide(),c=!0);for(var p=0;p!==8;p++)if(h[p].insert(t,i,a+1))return!0;c&&(h.length=0)}return s.push(i),!0};var l=new e;r.prototype.subdivide=function(){var t=this.aabb,i=t.lowerBound,a=t.upperBound,s=this.children;s.push(new r({aabb:new u({lowerBound:new e(0,0,0)})}),new r({aabb:new u({lowerBound:new e(1,0,0)})}),new r({aabb:new u({lowerBound:new e(1,1,0)})}),new r({aabb:new u({lowerBound:new e(1,1,1)})}),new r({aabb:new u({lowerBound:new e(0,1,1)})}),new r({aabb:new u({lowerBound:new e(0,0,1)})}),new r({aabb:new u({lowerBound:new e(1,0,1)})}),new r({aabb:new u({lowerBound:new e(0,1,0)})})),a.vsub(i,l),l.scale(.5,l);for(var h=this.root||this,c=0;c!==8;c++){var p=s[c];p.root=h;var f=p.aabb.lowerBound;f.x*=l.x,f.y*=l.y,f.z*=l.z,f.vadd(i,f),f.vadd(l,p.aabb.upperBound)}},r.prototype.aabbQuery=function(t,i){this.data,this.children;for(var a=[this];a.length;){var s=a.pop();s.aabb.overlaps(t)&&Array.prototype.push.apply(i,s.data),Array.prototype.push.apply(a,s.children)}return i};var o=new u;r.prototype.rayQuery=function(t,i,a){return t.getAABB(o),o.toLocalFrame(i,o),this.aabbQuery(o,a),a},r.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var i=t.pop(),a=i.children.length-1;a>=0;a--)i.children[a].data.length||i.children.splice(a,1);Array.prototype.push.apply(t,i.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(d,v,_){v.exports=u;function u(){this.objects=[],this.type=Object}u.prototype.release=function(){for(var e=arguments.length,r=0;r!==e;r++)this.objects.push(arguments[r])},u.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},u.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(d,v,_){v.exports=u;function u(){this.data={keys:[]}}u.prototype.get=function(e,r){if(e>r){var n=r;r=e,e=n}return this.data[e+"-"+r]},u.prototype.set=function(e,r,n){if(e>r){var l=r;r=e,e=l}var o=e+"-"+r;this.get(e,r)||this.data.keys.push(o),this.data[o]=n},u.prototype.reset=function(){for(var e=this.data,r=e.keys;r.length>0;){var n=r.pop();delete e[n]}}},{}],53:[function(d,v,_){function u(){}v.exports=u,u.defaults=function(e,r){e=e||{};for(var n in r)n in e||(e[n]=r[n]);return e}},{}],54:[function(d,v,_){v.exports=r;var u=d("../math/Vec3"),e=d("./Pool");function r(){e.call(this),this.type=u}r.prototype=new e,r.prototype.constructObject=function(){return new u}},{"../math/Vec3":30,"./Pool":51}],55:[function(d,v,_){v.exports=s;var u=d("../collision/AABB"),e=d("../shapes/Shape"),r=d("../collision/Ray"),n=d("../math/Vec3"),l=d("../math/Transform");d("../shapes/ConvexPolyhedron");var o=d("../math/Quaternion");d("../solver/Solver");var t=d("../utils/Vec3Pool"),i=d("../equations/ContactEquation"),a=d("../equations/FrictionEquation");function s(N){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=N,this.currentContactMaterial=null,this.enableFrictionReduction=!1}s.prototype.createContactEquation=function(N,O,G,X,wt,lt){var et;this.contactPointPool.length?(et=this.contactPointPool.pop(),et.bi=N,et.bj=O):et=new i(N,O),et.enabled=N.collisionResponse&&O.collisionResponse&&G.collisionResponse&&X.collisionResponse;var rt=this.currentContactMaterial;et.restitution=rt.restitution,et.setSpookParams(rt.contactEquationStiffness,rt.contactEquationRelaxation,this.world.dt);var P=G.material||N.material,ot=X.material||O.material;return P&&ot&&P.restitution>=0&&ot.restitution>=0&&(et.restitution=P.restitution*ot.restitution),et.si=wt||G,et.sj=lt||X,et},s.prototype.createFrictionEquationsFromContact=function(N,O){var G=N.bi,X=N.bj,wt=N.si,lt=N.sj,et=this.world,rt=this.currentContactMaterial,P=rt.friction,ot=wt.material||G.material,st=lt.material||X.material;if(ot&&st&&ot.friction>=0&&st.friction>=0&&(P=ot.friction*st.friction),P>0){var ut=P*et.gravity.length(),it=G.invMass+X.invMass;it>0&&(it=1/it);var tt=this.frictionEquationPool,nt=tt.length?tt.pop():new a(G,X,ut*it),ft=tt.length?tt.pop():new a(G,X,ut*it);return nt.bi=ft.bi=G,nt.bj=ft.bj=X,nt.minForce=ft.minForce=-ut*it,nt.maxForce=ft.maxForce=ut*it,nt.ri.copy(N.ri),nt.rj.copy(N.rj),ft.ri.copy(N.ri),ft.rj.copy(N.rj),N.ni.tangents(nt.t,ft.t),nt.setSpookParams(rt.frictionEquationStiffness,rt.frictionEquationRelaxation,et.dt),ft.setSpookParams(rt.frictionEquationStiffness,rt.frictionEquationRelaxation,et.dt),nt.enabled=ft.enabled=N.enabled,O.push(nt,ft),!0}return!1};var h=new n,c=new n,p=new n;s.prototype.createFrictionFromAverage=function(N){var O=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(O,this.frictionResult)||N===1)){var G=this.frictionResult[this.frictionResult.length-2],X=this.frictionResult[this.frictionResult.length-1];h.setZero(),c.setZero(),p.setZero();var wt=O.bi;O.bj;for(var lt=0;lt!==N;lt++)O=this.result[this.result.length-1-lt],O.bodyA!==wt?(h.vadd(O.ni,h),c.vadd(O.ri,c),p.vadd(O.rj,p)):(h.vsub(O.ni,h),c.vadd(O.rj,c),p.vadd(O.ri,p));var et=1/N;c.scale(et,G.ri),p.scale(et,G.rj),X.ri.copy(G.ri),X.rj.copy(G.rj),h.normalize(),h.tangents(G.t,X.t)}};var f=new n,w=new n,m=new o,B=new o;s.prototype.getContacts=function(N,O,G,X,wt,lt,et){this.contactPointPool=wt,this.frictionEquationPool=et,this.result=X,this.frictionResult=lt;for(var rt=m,P=B,ot=f,st=w,ut=0,it=N.length;ut!==it;ut++){var tt=N[ut],nt=O[ut],ft=null;tt.material&&nt.material&&(ft=G.getContactMaterial(tt.material,nt.material)||null);for(var gt=0;gt<tt.shapes.length;gt++){tt.quaternion.mult(tt.shapeOrientations[gt],rt),tt.quaternion.vmult(tt.shapeOffsets[gt],ot),ot.vadd(tt.position,ot);for(var K=tt.shapes[gt],Et=0;Et<nt.shapes.length;Et++){nt.quaternion.mult(nt.shapeOrientations[Et],P),nt.quaternion.vmult(nt.shapeOffsets[Et],st),st.vadd(nt.position,st);var At=nt.shapes[Et];if(!(ot.distanceTo(st)>K.boundingSphereRadius+At.boundingSphereRadius)){var Ht=null;K.material&&At.material&&(Ht=G.getContactMaterial(K.material,At.material)||null),this.currentContactMaterial=Ht||ft||G.defaultContactMaterial;var Bt=this[K.type|At.type];Bt&&(K.type<At.type?Bt.call(this,K,At,ot,st,rt,P,tt,nt,K,At):Bt.call(this,At,K,st,ot,P,rt,nt,tt,K,At))}}}}},s.prototype[e.types.BOX|e.types.BOX]=s.prototype.boxBox=function(N,O,G,X,wt,lt,et,rt){N.convexPolyhedronRepresentation.material=N.material,O.convexPolyhedronRepresentation.material=O.material,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,O.convexPolyhedronRepresentation.collisionResponse=O.collisionResponse,this.convexConvex(N.convexPolyhedronRepresentation,O.convexPolyhedronRepresentation,G,X,wt,lt,et,rt,N,O)},s.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=s.prototype.boxConvex=function(N,O,G,X,wt,lt,et,rt){N.convexPolyhedronRepresentation.material=N.material,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,this.convexConvex(N.convexPolyhedronRepresentation,O,G,X,wt,lt,et,rt,N,O)},s.prototype[e.types.BOX|e.types.PARTICLE]=s.prototype.boxParticle=function(N,O,G,X,wt,lt,et,rt){N.convexPolyhedronRepresentation.material=N.material,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,this.convexParticle(N.convexPolyhedronRepresentation,O,G,X,wt,lt,et,rt,N,O)},s.prototype[e.types.SPHERE]=s.prototype.sphereSphere=function(N,O,G,X,wt,lt,et,rt){var P=this.createContactEquation(et,rt,N,O);X.vsub(G,P.ni),P.ni.normalize(),P.ri.copy(P.ni),P.rj.copy(P.ni),P.ri.mult(N.radius,P.ri),P.rj.mult(-O.radius,P.rj),P.ri.vadd(G,P.ri),P.ri.vsub(et.position,P.ri),P.rj.vadd(X,P.rj),P.rj.vsub(rt.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)};var U=new n,Y=new n,V=new n;s.prototype[e.types.PLANE|e.types.TRIMESH]=s.prototype.planeTrimesh=function(N,O,G,X,wt,lt,et,rt){var P=new n,ot=U;ot.set(0,0,1),wt.vmult(ot,ot);for(var st=0;st<O.vertices.length/3;st++){O.getVertex(st,P);var ut=new n;ut.copy(P),l.pointToWorldFrame(X,lt,ut,P);var it=Y;P.vsub(G,it);var tt=ot.dot(it);if(tt<=0){var nt=this.createContactEquation(et,rt,N,O);nt.ni.copy(ot);var ft=V;ot.scale(it.dot(ot),ft),P.vsub(ft,ft),nt.ri.copy(ft),nt.ri.vsub(et.position,nt.ri),nt.rj.copy(P),nt.rj.vsub(rt.position,nt.rj),this.result.push(nt),this.createFrictionEquationsFromContact(nt,this.frictionResult)}}};var D=new n,R=new n;new n;var A=new n,F=new n,I=new n,$=new n,J=new n,vt=new n,z=new n,C=new n,j=new n,q=new n,b=new n,T=new u,g=[];s.prototype[e.types.SPHERE|e.types.TRIMESH]=s.prototype.sphereTrimesh=function(N,O,G,X,wt,lt,et,rt){var P=I,ot=$,st=J,ut=vt,it=z,tt=C,nt=T,ft=F,gt=R,K=g;l.pointToLocalFrame(X,lt,G,it);var Et=N.radius;nt.lowerBound.set(it.x-Et,it.y-Et,it.z-Et),nt.upperBound.set(it.x+Et,it.y+Et,it.z+Et),O.getTrianglesInAABB(nt,K);for(var At=A,Ht=N.radius*N.radius,Bt=0;Bt<K.length;Bt++)for(var Tt=0;Tt<3;Tt++)if(O.getVertex(O.indices[K[Bt]*3+Tt],At),At.vsub(it,gt),gt.norm2()<=Ht){ft.copy(At),l.pointToWorldFrame(X,lt,ft,At),At.vsub(G,gt);var yt=this.createContactEquation(et,rt,N,O);yt.ni.copy(gt),yt.ni.normalize(),yt.ri.copy(yt.ni),yt.ri.scale(N.radius,yt.ri),yt.ri.vadd(G,yt.ri),yt.ri.vsub(et.position,yt.ri),yt.rj.copy(At),yt.rj.vsub(rt.position,yt.rj),this.result.push(yt),this.createFrictionEquationsFromContact(yt,this.frictionResult)}for(var Bt=0;Bt<K.length;Bt++)for(var Tt=0;Tt<3;Tt++){O.getVertex(O.indices[K[Bt]*3+Tt],P),O.getVertex(O.indices[K[Bt]*3+(Tt+1)%3],ot),ot.vsub(P,st),it.vsub(ot,tt);var pe=tt.dot(st);it.vsub(P,tt);var ve=tt.dot(st);if(ve>0&&pe<0){it.vsub(P,tt),ut.copy(st),ut.normalize(),ve=tt.dot(ut),ut.scale(ve,tt),tt.vadd(P,tt);var te=tt.distanceTo(it);if(te<N.radius){var yt=this.createContactEquation(et,rt,N,O);tt.vsub(it,yt.ni),yt.ni.normalize(),yt.ni.scale(N.radius,yt.ri),l.pointToWorldFrame(X,lt,tt,tt),tt.vsub(rt.position,yt.rj),l.vectorToWorldFrame(lt,yt.ni,yt.ni),l.vectorToWorldFrame(lt,yt.ri,yt.ri),this.result.push(yt),this.createFrictionEquationsFromContact(yt,this.frictionResult)}}}for(var be=j,ee=q,Lt=b,Ee=D,Bt=0,kt=K.length;Bt!==kt;Bt++){O.getTriangleVertices(K[Bt],be,ee,Lt),O.getNormal(K[Bt],Ee),it.vsub(be,tt);var te=tt.dot(Ee);if(Ee.scale(te,tt),it.vsub(tt,tt),te=tt.distanceTo(it),r.pointInTriangle(tt,be,ee,Lt)&&te<N.radius){var yt=this.createContactEquation(et,rt,N,O);tt.vsub(it,yt.ni),yt.ni.normalize(),yt.ni.scale(N.radius,yt.ri),l.pointToWorldFrame(X,lt,tt,tt),tt.vsub(rt.position,yt.rj),l.vectorToWorldFrame(lt,yt.ni,yt.ni),l.vectorToWorldFrame(lt,yt.ri,yt.ri),this.result.push(yt),this.createFrictionEquationsFromContact(yt,this.frictionResult)}}K.length=0};var x=new n,y=new n;s.prototype[e.types.SPHERE|e.types.PLANE]=s.prototype.spherePlane=function(N,O,G,X,wt,lt,et,rt){var P=this.createContactEquation(et,rt,N,O);if(P.ni.set(0,0,1),lt.vmult(P.ni,P.ni),P.ni.negate(P.ni),P.ni.normalize(),P.ni.mult(N.radius,P.ri),G.vsub(X,x),P.ni.mult(P.ni.dot(x),y),x.vsub(y,P.rj),-x.dot(P.ni)<=N.radius){var ot=P.ri,st=P.rj;ot.vadd(G,ot),ot.vsub(et.position,ot),st.vadd(X,st),st.vsub(rt.position,st),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}};var M=new n,H=new n,W=new n;function S(N,O,G){for(var X=null,wt=N.length,lt=0;lt!==wt;lt++){var et=N[lt],rt=M;N[(lt+1)%wt].vsub(et,rt);var P=H;rt.cross(O,P);var ot=W;G.vsub(et,ot);var st=P.dot(ot);if(X===null||st>0&&X===!0||st<=0&&X===!1){X===null&&(X=st>0);continue}else return!1}return!0}var L=new n,Z=new n,dt=new n,ct=new n,at=[new n,new n,new n,new n,new n,new n],k=new n,Q=new n,Ct=new n,mt=new n;s.prototype[e.types.SPHERE|e.types.BOX]=s.prototype.sphereBox=function(N,O,G,X,wt,lt,et,rt){var P=this.v3pool,ot=at;G.vsub(X,L),O.getSideNormals(ot,lt);for(var st=N.radius,ut=!1,it=Q,tt=Ct,nt=mt,ft=null,gt=0,K=0,Et=0,At=null,Ht=0,Bt=ot.length;Ht!==Bt&&ut===!1;Ht++){var Tt=Z;Tt.copy(ot[Ht]);var yt=Tt.norm();Tt.normalize();var pe=L.dot(Tt);if(pe<yt+st&&pe>0){var ve=dt,te=ct;ve.copy(ot[(Ht+1)%3]),te.copy(ot[(Ht+2)%3]);var be=ve.norm(),ee=te.norm();ve.normalize(),te.normalize();var Lt=L.dot(ve),Ee=L.dot(te);if(Lt<be&&Lt>-be&&Ee<ee&&Ee>-ee){var Xt=Math.abs(pe-yt-st);(At===null||Xt<At)&&(At=Xt,K=Lt,Et=Ee,ft=yt,it.copy(Tt),tt.copy(ve),nt.copy(te),gt++)}}}if(gt){ut=!0;var xt=this.createContactEquation(et,rt,N,O);it.mult(-st,xt.ri),xt.ni.copy(it),xt.ni.negate(xt.ni),it.mult(ft,it),tt.mult(K,tt),it.vadd(tt,it),nt.mult(Et,nt),it.vadd(nt,xt.rj),xt.ri.vadd(G,xt.ri),xt.ri.vsub(et.position,xt.ri),xt.rj.vadd(X,xt.rj),xt.rj.vsub(rt.position,xt.rj),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}for(var kt=P.get(),Ae=k,oe=0;oe!==2&&!ut;oe++)for(var Kt=0;Kt!==2&&!ut;Kt++)for(var Zt=0;Zt!==2&&!ut;Zt++)if(kt.set(0,0,0),oe?kt.vadd(ot[0],kt):kt.vsub(ot[0],kt),Kt?kt.vadd(ot[1],kt):kt.vsub(ot[1],kt),Zt?kt.vadd(ot[2],kt):kt.vsub(ot[2],kt),X.vadd(kt,Ae),Ae.vsub(G,Ae),Ae.norm2()<st*st){ut=!0;var xt=this.createContactEquation(et,rt,N,O);xt.ri.copy(Ae),xt.ri.normalize(),xt.ni.copy(xt.ri),xt.ri.mult(st,xt.ri),xt.rj.copy(kt),xt.ri.vadd(G,xt.ri),xt.ri.vsub(et.position,xt.ri),xt.rj.vadd(X,xt.rj),xt.rj.vsub(rt.position,xt.rj),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}P.release(kt),kt=null;for(var de=P.get(),Be=P.get(),xt=P.get(),ne=P.get(),Xt=P.get(),Ce=ot.length,oe=0;oe!==Ce&&!ut;oe++)for(var Kt=0;Kt!==Ce&&!ut;Kt++)if(oe%3!==Kt%3){ot[Kt].cross(ot[oe],de),de.normalize(),ot[oe].vadd(ot[Kt],Be),xt.copy(G),xt.vsub(Be,xt),xt.vsub(X,xt);var Se=xt.dot(de);de.mult(Se,ne);for(var Zt=0;Zt===oe%3||Zt===Kt%3;)Zt++;Xt.copy(G),Xt.vsub(ne,Xt),Xt.vsub(Be,Xt),Xt.vsub(X,Xt);var ao=Math.abs(Se),ro=Xt.norm();if(ao<ot[Zt].norm()&&ro<st){ut=!0;var qt=this.createContactEquation(et,rt,N,O);Be.vadd(ne,qt.rj),qt.rj.copy(qt.rj),Xt.negate(qt.ni),qt.ni.normalize(),qt.ri.copy(qt.rj),qt.ri.vadd(X,qt.ri),qt.ri.vsub(G,qt.ri),qt.ri.normalize(),qt.ri.mult(st,qt.ri),qt.ri.vadd(G,qt.ri),qt.ri.vsub(et.position,qt.ri),qt.rj.vadd(X,qt.rj),qt.rj.vsub(rt.position,qt.rj),this.result.push(qt),this.createFrictionEquationsFromContact(qt,this.frictionResult)}}P.release(de,Be,xt,ne,Xt)};var Vt=new n,ht=new n,Rt=new n,Nt=new n,Pt=new n,Ft=new n,Mt=new n,It=new n,St=new n,Ut=new n;s.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=s.prototype.sphereConvex=function(N,O,G,X,wt,lt,et,rt){var P=this.v3pool;G.vsub(X,Vt);for(var ot=O.faceNormals,st=O.faces,ut=O.vertices,it=N.radius,tt=0;tt!==ut.length;tt++){var nt=ut[tt],ft=Pt;lt.vmult(nt,ft),X.vadd(ft,ft);var gt=Nt;if(ft.vsub(G,gt),gt.norm2()<it*it){Et=!0;var K=this.createContactEquation(et,rt,N,O);K.ri.copy(gt),K.ri.normalize(),K.ni.copy(K.ri),K.ri.mult(it,K.ri),ft.vsub(X,K.rj),K.ri.vadd(G,K.ri),K.ri.vsub(et.position,K.ri),K.rj.vadd(X,K.rj),K.rj.vsub(rt.position,K.rj),this.result.push(K),this.createFrictionEquationsFromContact(K,this.frictionResult);return}}for(var Et=!1,tt=0,At=st.length;tt!==At&&Et===!1;tt++){var Ht=ot[tt],Bt=st[tt],Tt=Ft;lt.vmult(Ht,Tt);var yt=Mt;lt.vmult(ut[Bt[0]],yt),yt.vadd(X,yt);var pe=It;Tt.mult(-it,pe),G.vadd(pe,pe);var ve=St;pe.vsub(yt,ve);var te=ve.dot(Tt),be=Ut;if(G.vsub(yt,be),te<0&&be.dot(Tt)>0){for(var ee=[],Lt=0,Ee=Bt.length;Lt!==Ee;Lt++){var kt=P.get();lt.vmult(ut[Bt[Lt]],kt),X.vadd(kt,kt),ee.push(kt)}if(S(ee,Tt,G)){Et=!0;var K=this.createContactEquation(et,rt,N,O);Tt.mult(-it,K.ri),Tt.negate(K.ni);var Ae=P.get();Tt.mult(-te,Ae);var oe=P.get();Tt.mult(-it,oe),G.vsub(X,K.rj),K.rj.vadd(oe,K.rj),K.rj.vadd(Ae,K.rj),K.rj.vadd(X,K.rj),K.rj.vsub(rt.position,K.rj),K.ri.vadd(G,K.ri),K.ri.vsub(et.position,K.ri),P.release(Ae),P.release(oe),this.result.push(K),this.createFrictionEquationsFromContact(K,this.frictionResult);for(var Lt=0,Kt=ee.length;Lt!==Kt;Lt++)P.release(ee[Lt]);return}else for(var Lt=0;Lt!==Bt.length;Lt++){var Zt=P.get(),de=P.get();lt.vmult(ut[Bt[(Lt+1)%Bt.length]],Zt),lt.vmult(ut[Bt[(Lt+2)%Bt.length]],de),X.vadd(Zt,Zt),X.vadd(de,de);var Be=ht;de.vsub(Zt,Be);var xt=Rt;Be.unit(xt);var ne=P.get(),Xt=P.get();G.vsub(Zt,Xt);var Ce=Xt.dot(xt);xt.mult(Ce,ne),ne.vadd(Zt,ne);var Se=P.get();if(ne.vsub(G,Se),Ce>0&&Ce*Ce<Be.norm2()&&Se.norm2()<it*it){var K=this.createContactEquation(et,rt,N,O);ne.vsub(X,K.rj),ne.vsub(G,K.ni),K.ni.normalize(),K.ni.mult(it,K.ri),K.rj.vadd(X,K.rj),K.rj.vsub(rt.position,K.rj),K.ri.vadd(G,K.ri),K.ri.vsub(et.position,K.ri),this.result.push(K),this.createFrictionEquationsFromContact(K,this.frictionResult);for(var Lt=0,Kt=ee.length;Lt!==Kt;Lt++)P.release(ee[Lt]);P.release(Zt),P.release(de),P.release(ne),P.release(Se),P.release(Xt);return}P.release(Zt),P.release(de),P.release(ne),P.release(Se),P.release(Xt)}for(var Lt=0,Kt=ee.length;Lt!==Kt;Lt++)P.release(ee[Lt])}}},new n,new n,s.prototype[e.types.PLANE|e.types.BOX]=s.prototype.planeBox=function(N,O,G,X,wt,lt,et,rt){O.convexPolyhedronRepresentation.material=O.material,O.convexPolyhedronRepresentation.collisionResponse=O.collisionResponse,this.planeConvex(N,O.convexPolyhedronRepresentation,G,X,wt,lt,et,rt)};var Qt=new n,le=new n,ce=new n,E=new n;s.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=s.prototype.planeConvex=function(N,O,G,X,wt,lt,et,rt){var P=Qt,ot=le;ot.set(0,0,1),wt.vmult(ot,ot);for(var st=0,ut=ce,it=0;it!==O.vertices.length;it++){P.copy(O.vertices[it]),lt.vmult(P,P),X.vadd(P,P),P.vsub(G,ut);var tt=ot.dot(ut);if(tt<=0){var nt=this.createContactEquation(et,rt,N,O),ft=E;ot.mult(ot.dot(ut),ft),P.vsub(ft,ft),ft.vsub(G,nt.ri),nt.ni.copy(ot),P.vsub(X,nt.rj),nt.ri.vadd(G,nt.ri),nt.ri.vsub(et.position,nt.ri),nt.rj.vadd(X,nt.rj),nt.rj.vsub(rt.position,nt.rj),this.result.push(nt),st++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(nt,this.frictionResult)}}this.enableFrictionReduction&&st&&this.createFrictionFromAverage(st)};var pt=new n,zt=new n;s.prototype[e.types.CONVEXPOLYHEDRON]=s.prototype.convexConvex=function(N,O,G,X,wt,lt,et,rt,P,ot,st,ut){var it=pt;if(!(G.distanceTo(X)>N.boundingSphereRadius+O.boundingSphereRadius)&&N.findSeparatingAxis(O,G,wt,X,lt,it,st,ut)){var tt=[],nt=zt;N.clipAgainstHull(G,wt,O,X,lt,it,-100,100,tt);for(var ft=0,gt=0;gt!==tt.length;gt++){var K=this.createContactEquation(et,rt,N,O,P,ot),Et=K.ri,At=K.rj;it.negate(K.ni),tt[gt].normal.negate(nt),nt.mult(tt[gt].depth,nt),tt[gt].point.vadd(nt,Et),At.copy(tt[gt].point),Et.vsub(G,Et),At.vsub(X,At),Et.vadd(G,Et),Et.vsub(et.position,Et),At.vadd(X,At),At.vsub(rt.position,At),this.result.push(K),ft++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(K,this.frictionResult)}this.enableFrictionReduction&&ft&&this.createFrictionFromAverage(ft)}};var Wt=new n,Dt=new n,_t=new n;s.prototype[e.types.PLANE|e.types.PARTICLE]=s.prototype.planeParticle=function(N,O,G,X,wt,lt,et,rt){var P=Wt;P.set(0,0,1),et.quaternion.vmult(P,P);var ot=Dt;X.vsub(et.position,ot);var st=P.dot(ot);if(st<=0){var ut=this.createContactEquation(rt,et,O,N);ut.ni.copy(P),ut.ni.negate(ut.ni),ut.ri.set(0,0,0);var it=_t;P.mult(P.dot(X),it),X.vsub(it,it),ut.rj.copy(it),this.result.push(ut),this.createFrictionEquationsFromContact(ut,this.frictionResult)}};var Gt=new n;s.prototype[e.types.PARTICLE|e.types.SPHERE]=s.prototype.sphereParticle=function(N,O,G,X,wt,lt,et,rt){var P=Gt;P.set(0,0,1),X.vsub(G,P);var ot=P.norm2();if(ot<=N.radius*N.radius){var st=this.createContactEquation(rt,et,O,N);P.normalize(),st.rj.copy(P),st.rj.mult(N.radius,st.rj),st.ni.copy(P),st.ni.negate(st.ni),st.ri.set(0,0,0),this.result.push(st),this.createFrictionEquationsFromContact(st,this.frictionResult)}};var Jt=new o,he=new n;new n;var $t=new n,Ot=new n,jt=new n;s.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=s.prototype.convexParticle=function(N,O,G,X,wt,lt,et,rt){var P=-1,ot=$t,st=jt,ut=null,it=he;if(it.copy(X),it.vsub(G,it),wt.conjugate(Jt),Jt.vmult(it,it),N.pointIsInside(it)){N.worldVerticesNeedsUpdate&&N.computeWorldVertices(G,wt),N.worldFaceNormalsNeedsUpdate&&N.computeWorldFaceNormals(wt);for(var tt=0,nt=N.faces.length;tt!==nt;tt++){var ft=[N.worldVertices[N.faces[tt][0]]],gt=N.worldFaceNormals[tt];X.vsub(ft[0],Ot);var K=-gt.dot(Ot);(ut===null||Math.abs(K)<Math.abs(ut))&&(ut=K,P=tt,ot.copy(gt))}if(P!==-1){var Et=this.createContactEquation(rt,et,O,N);ot.mult(ut,st),st.vadd(X,st),st.vsub(G,st),Et.rj.copy(st),ot.negate(Et.ni),Et.ri.set(0,0,0);var At=Et.ri,Ht=Et.rj;At.vadd(X,At),At.vsub(rt.position,At),Ht.vadd(G,Ht),Ht.vsub(et.position,Ht),this.result.push(Et),this.createFrictionEquationsFromContact(Et,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},s.prototype[e.types.BOX|e.types.HEIGHTFIELD]=s.prototype.boxHeightfield=function(N,O,G,X,wt,lt,et,rt){N.convexPolyhedronRepresentation.material=N.material,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,this.convexHeightfield(N.convexPolyhedronRepresentation,O,G,X,wt,lt,et,rt)};var fe=new n,ie=new n,ue=[0];s.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=s.prototype.convexHeightfield=function(N,O,G,X,wt,lt,et,rt){var P=O.data,ot=O.elementSize,st=N.boundingSphereRadius,ut=ie,it=ue,tt=fe;l.pointToLocalFrame(X,lt,G,tt);var nt=Math.floor((tt.x-st)/ot)-1,ft=Math.ceil((tt.x+st)/ot)+1,gt=Math.floor((tt.y-st)/ot)-1,K=Math.ceil((tt.y+st)/ot)+1;if(!(ft<0||K<0||nt>P.length||gt>P[0].length)){nt<0&&(nt=0),ft<0&&(ft=0),gt<0&&(gt=0),K<0&&(K=0),nt>=P.length&&(nt=P.length-1),ft>=P.length&&(ft=P.length-1),K>=P[0].length&&(K=P[0].length-1),gt>=P[0].length&&(gt=P[0].length-1);var Et=[];O.getRectMinMax(nt,gt,ft,K,Et);var At=Et[0],Ht=Et[1];if(!(tt.z-st>Ht||tt.z+st<At))for(var Bt=nt;Bt<ft;Bt++)for(var Tt=gt;Tt<K;Tt++)O.getConvexTrianglePillar(Bt,Tt,!1),l.pointToWorldFrame(X,lt,O.pillarOffset,ut),G.distanceTo(ut)<O.pillarConvex.boundingSphereRadius+N.boundingSphereRadius&&this.convexConvex(N,O.pillarConvex,G,ut,wt,lt,et,rt,null,null,it,null),O.getConvexTrianglePillar(Bt,Tt,!0),l.pointToWorldFrame(X,lt,O.pillarOffset,ut),G.distanceTo(ut)<O.pillarConvex.boundingSphereRadius+N.boundingSphereRadius&&this.convexConvex(N,O.pillarConvex,G,ut,wt,lt,et,rt,null,null,it,null)}};var me=new n,Yt=new n;s.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=s.prototype.sphereHeightfield=function(N,O,G,X,wt,lt,et,rt){var P=O.data,ot=N.radius,st=O.elementSize,ut=Yt,it=me;l.pointToLocalFrame(X,lt,G,it);var tt=Math.floor((it.x-ot)/st)-1,nt=Math.ceil((it.x+ot)/st)+1,ft=Math.floor((it.y-ot)/st)-1,gt=Math.ceil((it.y+ot)/st)+1;if(!(nt<0||gt<0||tt>P.length||gt>P[0].length)){tt<0&&(tt=0),nt<0&&(nt=0),ft<0&&(ft=0),gt<0&&(gt=0),tt>=P.length&&(tt=P.length-1),nt>=P.length&&(nt=P.length-1),gt>=P[0].length&&(gt=P[0].length-1),ft>=P[0].length&&(ft=P[0].length-1);var K=[];O.getRectMinMax(tt,ft,nt,gt,K);var Et=K[0],At=K[1];if(!(it.z-ot>At||it.z+ot<Et))for(var Ht=this.result,Bt=tt;Bt<nt;Bt++)for(var Tt=ft;Tt<gt;Tt++){var yt=Ht.length;O.getConvexTrianglePillar(Bt,Tt,!1),l.pointToWorldFrame(X,lt,O.pillarOffset,ut),G.distanceTo(ut)<O.pillarConvex.boundingSphereRadius+N.boundingSphereRadius&&this.sphereConvex(N,O.pillarConvex,G,ut,wt,lt,et,rt),O.getConvexTrianglePillar(Bt,Tt,!0),l.pointToWorldFrame(X,lt,O.pillarOffset,ut),G.distanceTo(ut)<O.pillarConvex.boundingSphereRadius+N.boundingSphereRadius&&this.sphereConvex(N,O.pillarConvex,G,ut,wt,lt,et,rt);var pe=Ht.length-yt;if(pe>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(d,v,_){v.exports=m;var u=d("../shapes/Shape"),e=d("../math/Vec3"),r=d("../math/Quaternion"),n=d("../solver/GSSolver");d("../utils/Vec3Pool"),d("../equations/ContactEquation"),d("../equations/FrictionEquation");var l=d("./Narrowphase"),o=d("../utils/EventTarget"),t=d("../collision/ArrayCollisionMatrix"),i=d("../material/Material"),a=d("../material/ContactMaterial"),s=d("../objects/Body"),h=d("../utils/TupleDictionary"),c=d("../collision/RaycastResult"),p=d("../collision/AABB"),f=d("../collision/Ray"),w=d("../collision/NaiveBroadphase");function m(){o.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new w,this.bodies=[],this.solver=new n,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new h,this.defaultMaterial=new i("default"),this.defaultContactMaterial=new a(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}m.prototype=new o,new p;var B=new f;if(m.prototype.getContactMaterial=function(C,j){return this.contactMaterialTable.get(C.id,j.id)},m.prototype.numObjects=function(){return this.bodies.length},m.prototype.collisionMatrixTick=function(){var C=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=C,this.collisionMatrix.reset()},m.prototype.add=m.prototype.addBody=function(C){this.bodies.indexOf(C)===-1&&(C.index=this.bodies.length,this.bodies.push(C),C.world=this,C.initPosition.copy(C.position),C.initVelocity.copy(C.velocity),C.timeLastSleepy=this.time,C instanceof s&&(C.initAngularVelocity.copy(C.angularVelocity),C.initQuaternion.copy(C.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=C,this.dispatchEvent(this.addBodyEvent))},m.prototype.addConstraint=function(C){this.constraints.push(C)},m.prototype.removeConstraint=function(C){var j=this.constraints.indexOf(C);j!==-1&&this.constraints.splice(j,1)},m.prototype.rayTest=function(C,j,q){q instanceof c?this.raycastClosest(C,j,{skipBackfaces:!0},q):this.raycastAll(C,j,{skipBackfaces:!0},q)},m.prototype.raycastAll=function(C,j,q,b){return q.mode=f.ALL,q.from=C,q.to=j,q.callback=b,B.intersectWorld(this,q)},m.prototype.raycastAny=function(C,j,q,b){return q.mode=f.ANY,q.from=C,q.to=j,q.result=b,B.intersectWorld(this,q)},m.prototype.raycastClosest=function(C,j,q,b){return q.mode=f.CLOSEST,q.from=C,q.to=j,q.result=b,B.intersectWorld(this,q)},m.prototype.remove=function(C){C.world=null;var j=this.bodies.length-1,q=this.bodies,b=q.indexOf(C);if(b!==-1){q.splice(b,1);for(var T=0;T!==q.length;T++)q[T].index=T;this.collisionMatrix.setNumObjects(j),this.removeBodyEvent.body=C,this.dispatchEvent(this.removeBodyEvent)}},m.prototype.removeBody=m.prototype.remove,m.prototype.addMaterial=function(C){this.materials.push(C)},m.prototype.addContactMaterial=function(C){this.contactmaterials.push(C),this.contactMaterialTable.set(C.materials[0].id,C.materials[1].id,C)},typeof performance>"u"&&(performance={}),!performance.now){var U=Date.now();performance.timing&&performance.timing.navigationStart&&(U=performance.timing.navigationStart),performance.now=function(){return Date.now()-U}}var Y=new e;m.prototype.step=function(C,j,q){if(q=q||10,j=j||0,j===0)this.internalStep(C),this.time+=C;else{var b=Math.floor((this.time+j)/C)-Math.floor(this.time/C);b=Math.min(b,q);for(var T=performance.now(),g=0;g!==b&&(this.internalStep(C),!(performance.now()-T>C*1e3));g++);this.time+=j;for(var x=this.time%C,y=x/C,M=Y,H=this.bodies,W=0;W!==H.length;W++){var S=H[W];S.type!==s.STATIC&&S.sleepState!==s.SLEEPING?(S.position.vsub(S.previousPosition,M),M.scale(y,M),S.position.vadd(M,S.interpolatedPosition)):(S.interpolatedPosition.copy(S.position),S.interpolatedQuaternion.copy(S.quaternion))}}};var V={type:"postStep"},D={type:"preStep"},R={type:"collide",body:null,contact:null},A=[],F=[],I=[],$=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new r;var J=new r,vt=new r,z=new e;m.prototype.internalStep=function(C){this.dt=C;var j=this.contacts,q=I,b=$,T=this.numObjects(),g=this.bodies,x=this.solver,y=this.gravity,M=this.doProfiling,H=this.profile,W=s.DYNAMIC,S,L=this.constraints,Z=F;y.norm();var dt=y.x,ct=y.y,at=y.z,k=0;for(M&&(S=performance.now()),k=0;k!==T;k++){var Q=g[k];if(Q.type&W){var Ct=Q.force,mt=Q.mass;Ct.x+=mt*dt,Ct.y+=mt*ct,Ct.z+=mt*at}}for(var k=0,Vt=this.subsystems.length;k!==Vt;k++)this.subsystems[k].update();M&&(S=performance.now()),q.length=0,b.length=0,this.broadphase.collisionPairs(this,q,b),M&&(H.broadphase=performance.now()-S);var pt=L.length;for(k=0;k!==pt;k++){var ht=L[k];if(!ht.collideConnected)for(var Rt=q.length-1;Rt>=0;Rt-=1)(ht.bodyA===q[Rt]&&ht.bodyB===b[Rt]||ht.bodyB===q[Rt]&&ht.bodyA===b[Rt])&&(q.splice(Rt,1),b.splice(Rt,1))}this.collisionMatrixTick(),M&&(S=performance.now());var Nt=A,Pt=j.length;for(k=0;k!==Pt;k++)Nt.push(j[k]);j.length=0;var Ft=this.frictionEquations.length;for(k=0;k!==Ft;k++)Z.push(this.frictionEquations[k]);this.frictionEquations.length=0,this.narrowphase.getContacts(q,b,this,j,Nt,this.frictionEquations,Z),M&&(H.narrowphase=performance.now()-S),M&&(S=performance.now());for(var k=0;k<this.frictionEquations.length;k++)x.addEquation(this.frictionEquations[k]);for(var Mt=j.length,It=0;It!==Mt;It++){var ht=j[It],Q=ht.bi,St=ht.bj;ht.si,ht.sj;var Ut;if(Q.material&&St.material?Ut=this.getContactMaterial(Q.material,St.material)||this.defaultContactMaterial:Ut=this.defaultContactMaterial,Ut.friction,Q.material&&St.material&&(Q.material.friction>=0&&St.material.friction>=0&&Q.material.friction*St.material.friction,Q.material.restitution>=0&&St.material.restitution>=0&&(ht.restitution=Q.material.restitution*St.material.restitution)),x.addEquation(ht),Q.allowSleep&&Q.type===s.DYNAMIC&&Q.sleepState===s.SLEEPING&&St.sleepState===s.AWAKE&&St.type!==s.STATIC){var Qt=St.velocity.norm2()+St.angularVelocity.norm2(),le=Math.pow(St.sleepSpeedLimit,2);Qt>=le*2&&(Q._wakeUpAfterNarrowphase=!0)}if(St.allowSleep&&St.type===s.DYNAMIC&&St.sleepState===s.SLEEPING&&Q.sleepState===s.AWAKE&&Q.type!==s.STATIC){var ce=Q.velocity.norm2()+Q.angularVelocity.norm2(),E=Math.pow(Q.sleepSpeedLimit,2);ce>=E*2&&(St._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,St,!0),this.collisionMatrixPrevious.get(Q,St)||(R.body=St,R.contact=ht,Q.dispatchEvent(R),R.body=Q,St.dispatchEvent(R))}for(M&&(H.makeContactConstraints=performance.now()-S,S=performance.now()),k=0;k!==T;k++){var Q=g[k];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var pt=L.length;for(k=0;k!==pt;k++){var ht=L[k];ht.update();for(var Rt=0,zt=ht.equations.length;Rt!==zt;Rt++){var Wt=ht.equations[Rt];x.addEquation(Wt)}}x.solve(C,this),M&&(H.solve=performance.now()-S),x.removeAllEquations();var Dt=Math.pow;for(k=0;k!==T;k++){var Q=g[k];if(Q.type&W){var _t=Dt(1-Q.linearDamping,C),Gt=Q.velocity;Gt.mult(_t,Gt);var Jt=Q.angularVelocity;if(Jt){var he=Dt(1-Q.angularDamping,C);Jt.mult(he,Jt)}}}for(this.dispatchEvent(D),k=0;k!==T;k++){var Q=g[k];Q.preStep&&Q.preStep.call(Q)}M&&(S=performance.now());var $t=J,Ot=vt,jt=this.stepnumber,fe=s.DYNAMIC|s.KINEMATIC,ie=jt%(this.quatNormalizeSkip+1)===0,ue=this.quatNormalizeFast,me=C*.5;for(u.types.PLANE,u.types.CONVEXPOLYHEDRON,k=0;k!==T;k++){var Yt=g[k],N=Yt.force,O=Yt.torque;if(Yt.type&fe&&Yt.sleepState!==s.SLEEPING){var G=Yt.velocity,X=Yt.angularVelocity,wt=Yt.position,lt=Yt.quaternion,et=Yt.invMass,rt=Yt.invInertiaWorld;G.x+=N.x*et*C,G.y+=N.y*et*C,G.z+=N.z*et*C,Yt.angularVelocity&&(rt.vmult(O,z),z.mult(C,z),z.vadd(X,X)),wt.x+=G.x*C,wt.y+=G.y*C,wt.z+=G.z*C,Yt.angularVelocity&&($t.set(X.x,X.y,X.z,0),$t.mult(lt,Ot),lt.x+=me*Ot.x,lt.y+=me*Ot.y,lt.z+=me*Ot.z,lt.w+=me*Ot.w,ie&&(ue?lt.normalizeFast():lt.normalize())),Yt.aabb&&(Yt.aabbNeedsUpdate=!0),Yt.updateInertiaWorld&&Yt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,M&&(H.integrate=performance.now()-S),this.time+=C,this.stepnumber+=1,this.dispatchEvent(V),k=0;k!==T;k++){var Q=g[k],P=Q.postStep;P&&P.call(Q)}if(this.allowSleep)for(k=0;k!==T;k++)g[k].sleepTick(this.time)},m.prototype.clearForces=function(){for(var C=this.bodies,j=C.length,q=0;q!==j;q++){var b=C[q];b.force,b.torque,b.force.set(0,0,0),b.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(eo);var Bo=eo.exports;const se=to(Bo);var oo={exports:{}};(function(bt,xe){(function(d,v){bt.exports=v()})(Ao,function(){var d=function(){function v(a){return e.appendChild(a.dom),a}function _(a){for(var s=0;s<e.children.length;s++)e.children[s].style.display=s===a?"block":"none";u=a}var u=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(a){a.preventDefault(),_(++u%e.children.length)},!1);var r=(performance||Date).now(),n=r,l=0,o=v(new d.Panel("FPS","#0ff","#002")),t=v(new d.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var i=v(new d.Panel("MB","#f08","#201"));return _(0),{REVISION:16,dom:e,addPanel:v,showPanel:_,begin:function(){r=(performance||Date).now()},end:function(){l++;var a=(performance||Date).now();if(t.update(a-r,200),a>n+1e3&&(o.update(1e3*l/(a-n),100),n=a,l=0,i)){var s=performance.memory;i.update(s.usedJSHeapSize/1048576,s.jsHeapSizeLimit/1048576)}return a},update:function(){r=this.end()},domElement:e,setMode:_}};return d.Panel=function(v,_,u){var e=1/0,r=0,n=Math.round,l=n(window.devicePixelRatio||1),o=80*l,t=48*l,i=3*l,a=2*l,s=3*l,h=15*l,c=74*l,p=30*l,f=document.createElement("canvas");f.width=o,f.height=t,f.style.cssText="width:80px;height:48px";var w=f.getContext("2d");return w.font="bold "+9*l+"px Helvetica,Arial,sans-serif",w.textBaseline="top",w.fillStyle=u,w.fillRect(0,0,o,t),w.fillStyle=_,w.fillText(v,i,a),w.fillRect(s,h,c,p),w.fillStyle=u,w.globalAlpha=.9,w.fillRect(s,h,c,p),{dom:f,update:function(m,B){e=Math.min(e,m),r=Math.max(r,m),w.fillStyle=u,w.globalAlpha=1,w.fillRect(0,0,o,h),w.fillStyle=_,w.fillText(n(m)+" "+v+" ("+n(e)+"-"+n(r)+")",i,a),w.drawImage(f,s+l,h,c-l,p,s,h,c-l,p),w.fillRect(s+c-l,h,l,p),w.fillStyle=u,w.globalAlpha=.9,w.fillRect(s+c-l,h,l,n((1-m/B)*p))}}},d})})(oo);var Co=oo.exports;const So=to(Co),ge=new se.World;ge.gravity.set(0,-20,0);ge.defaultContactMaterial.friction=1;ge.defaultContactMaterial.restitution=.5;ge.defaultContactMaterial.contactEquationStiffness=1e8;ge.defaultContactMaterial.contactEquationRelaxation=3;ge.defaultContactMaterial.frictionEquationStiffness=1e8;ge.defaultContactMaterial.frictionEquationRelaxation=3;const ke=uo(),Re=po(),ze=vo();ze.position.set(0,100,100);ze.lookAt(0,0,0);const we=new fo(16777215,1);we.position.set(80,80,80);we.castShadow=!0;we.receiveShadow=!0;we.shadow.mapSize.width=5120;we.shadow.mapSize.height=5120;we.shadow.camera.near=.5;we.shadow.camera.far=500;we.shadow.camera.visible=!0;we.shadow.camera.scale.set(20,20,20);Re.add(we);Re.add(new mo(we.shadow.camera));const Mo=new yo(16777215,1);Re.add(Mo);const io=new Eo(ze,ke.domElement);io.target.set(0,0,0);io.update();window.addEventListener("resize",()=>wo(ke,ze));const Ie=80,Po=new se.Box(new se.Vec3(Ie,1,Ie)),Le=new se.Body({mass:0,shape:Po});Le.position.set(0,-1,0);Le.material=new se.Material("groundMaterial");ge.addBody(Le);const Ro=new xo(Ie*2,2,Ie*2),To=new Je({color:11184810}),qe=new $e(Ro,To);qe.receiveShadow=!0;Re.add(qe);const{sphereBody:re,sphereMesh:zo}=Fo(3),Te=50;let De=!1,He=!1,Ue=!1,Ge=!1,Ye=!1,Fe=!1;window.addEventListener("keydown",Vo);window.addEventListener("keyup",No);const We=new So;We.showPanel(0);document.body.appendChild(We.dom);no();function no(){We.begin(),requestAnimationFrame(no),ge.step(1/60),Ke(Le,qe),Ke(re,zo),De&&re.applyForce(new se.Vec3(0,0,-Te),re.position),He&&re.applyForce(new se.Vec3(0,0,Te),re.position),Ue&&re.applyForce(new se.Vec3(-Te,0,0),re.position),Ge&&re.applyForce(new se.Vec3(Te,0,0),re.position),Ye&&(Fe||(Fe=!0,re.applyForce(new se.Vec3(0,Te*10,0),re.position))),Math.round(re.position.y)<=re.shapes[0].boundingSphereRadius?Fe=!1:Fe=!0,ke.render(Re,ze),We.end()}function Ke(bt,xe){xe.position.copy(bt.position),xe.quaternion.copy(bt.quaternion)}function Vo(bt){console.log(bt.key===" "?"Space":bt.key),(bt.key==="ArrowUp"||bt.key==="w")&&(De=!0),(bt.key==="ArrowDown"||bt.key==="s")&&(He=!0),(bt.key==="ArrowLeft"||bt.key==="a")&&(Ue=!0),(bt.key==="ArrowRight"||bt.key==="d")&&(Ge=!0),bt.key===" "&&(Ye=!0)}function No(bt){console.log("--",bt.key===" "?"Space":bt.key),(bt.key==="ArrowUp"||bt.key==="w")&&(De=!1),(bt.key==="ArrowDown"||bt.key==="s")&&(He=!1),(bt.key==="ArrowLeft"||bt.key==="a")&&(Ue=!1),(bt.key==="ArrowRight"||bt.key==="d")&&(Ge=!1),bt.key===" "&&(Ye=!1)}function Fo(bt=1){const xe=new se.Sphere(bt),d=new se.Body({mass:bt,shape:xe});d.position.set(0,5,0),d.material=new se.Material("sphereMaterial"),d.material.friction=1,d.material.restitution=1,d.linearDamping=.5,ge.addBody(d);const v=new go(bt,32,32),_=new Je({color:65280}),u=new $e(v,_);return u.castShadow=!0,u.receiveShadow=!0,Re.add(u),{sphereBody:d,sphereMesh:u}}
